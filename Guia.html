<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiniela Amigos SICAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @media print {
            /* Ocultar todo por defecto */
            body * {
                visibility: hidden;
            }
            
            /* Mostrar SOLO el ticket y su contenido */
            #printable-ticket, #printable-ticket * {
                visibility: visible;
            }

            /* Posicionar el ticket en la hoja */
            #printable-ticket {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                background: white;
                border: 2px dashed black !important; /* Asegurar borde punteado en impresi칩n */
                box-shadow: none !important;
            }

            /* Configuraciones de p치gina y color */
            @page { margin: 0; }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* Ocultar elementos de UI que no sean el ticket */
            .no-print, .print-hidden { display: none !important; }
        }

        /* Ocultar barra de scroll en tabs para est칠tica m칩vil */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, setDoc, getDocs, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { Trophy, Users, PlusCircle, CheckCircle, Clock, Search, FileText, LogOut, Shield, User, Printer, XCircle, Menu, X, Lock, RefreshCw, KeyRound, Calendar, Trash2, AlertTriangle, Banknote, ChevronDown, ChevronUp, Gamepad2, Check, Filter, Medal } from 'https://esm.sh/lucide-react@0.263.1';

        // --- CONFIGURACI칍N FIREBASE (PROYECTO EXISTENTE) ---
        const localConfig = {
          apiKey: "AIzaSyA6uydlodXo1vnyqoocwzHytwt5W0riIDQ",
          authDomain: "blackjack-d6b7b.firebaseapp.com",
          projectId: "blackjack-d6b7b",
          storageBucket: "blackjack-d6b7b.appspot.com",
          messagingSenderId: "705363226577",
          appId: "1:705363226577:web:214cf8baa2c9fb48e73af0"
        };

        let firebaseConfig;
        let appId = 'default-app-id';
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } else {
                firebaseConfig = localConfig;
            }
        } catch (e) { console.error(e); }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UTILERIAS DE TIEMPO ---
        const getTrustedTime = async () => {
            try {
                const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
                const data = await response.json();
                return new Date(data.utc_datetime); 
            } catch (error) {
                console.warn("Fallo al consultar hora online, usando fallback local:", error);
                return new Date(); 
            }
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [authUser, setAuthUser] = useState(null); 
            const [dbUser, setDbUser] = useState(null);     
            const [view, setView] = useState('auth');       
            const [teams, setTeams] = useState([]);
            const [matchdays, setMatchdays] = useState([]);
            const [bets, setBets] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setAuthUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!authUser) return;
                
                const unsubTeams = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'teams')), (s) => {
                    setTeams(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name)));
                });
                const unsubMatchdays = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'matchdays')), (s) => {
                    setMatchdays(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                });
                const unsubBets = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'bets')), (s) => {
                    setBets(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                return () => { unsubTeams(); unsubMatchdays(); unsubBets(); };
            }, [authUser]);

            const handleLogout = () => {
                setDbUser(null);
                setView('auth');
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-green-700 font-bold">Cargando...</div>;

            return (
                <div className="min-h-screen flex flex-col bg-gray-50">
                    <nav className="bg-green-700 text-white shadow-lg p-3 md:p-4 sticky top-0 z-50 no-print">
                        <div className="container mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2 overflow-hidden">
                                <Trophy className="text-yellow-300 shrink-0" />
                                <span className="font-bold text-lg md:text-xl truncate">Quiniela Amigos SICAR</span>
                            </div>
                            {dbUser && (
                                <div className="flex items-center gap-3 md:gap-4 shrink-0">
                                    <span className="hidden md:inline text-sm opacity-90 font-medium capitalize">
                                        {dbUser.fullName || dbUser.username}
                                    </span>
                                    <button onClick={handleLogout} className="hover:bg-green-600 p-2 rounded-full transition" title="Cerrar Sesi칩n">
                                        <LogOut size={20} />
                                    </button>
                                </div>
                            )}
                        </div>
                    </nav>

                    <main className="container mx-auto p-3 md:p-6 mb-20 flex-grow w-full max-w-5xl">
                        {view === 'auth' && <AuthView setDbUser={setDbUser} setView={setView} appId={appId} db={db} />}
                        {view === 'admin' && <AdminView teams={teams} matchdays={matchdays} bets={bets} user={dbUser} appId={appId} db={db} />}
                        {view === 'user' && <UserView teams={teams} matchdays={matchdays} bets={bets} user={dbUser} appId={appId} db={db} />}
                    </main>

                    <footer className="bg-gray-800 text-white p-4 text-center text-xs md:text-sm no-print">
                        Quiniela Amigos SICAR - Sistema Seguro
                    </footer>
                </div>
            );
        }

        function AuthView({ setDbUser, setView, appId, db }) {
            const [mode, setMode] = useState('login'); 
            const [formData, setFormData] = useState({ fullName: '', username: '', password: '', dob: '', newPassword: '' });
            const [error, setError] = useState('');

            const isValidUsername = (u) => /^[a-zA-Z0-9_]+$/.test(u);
            const isValidName = (n) => /^[a-zA-Z치칠칤칩칰츼칄칈칍칔침칌\s]+$/.test(n);
            
            const isAdult = (dateString) => {
                const today = new Date();
                const birthDate = new Date(dateString);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                return age >= 18;
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                if (!formData.fullName.trim()) return setError('Ingresa tu nombre completo.');
                if (!isValidName(formData.fullName)) return setError('El nombre solo debe contener letras.');
                if (!isValidUsername(formData.username)) return setError('Usuario inv치lido (solo letras, n칰meros y gui칩n bajo).');
                if (formData.password.length < 5) return setError('La contrase침a debe tener al menos 5 caracteres.');
                if (!isAdult(formData.dob)) return setError('Debes ser mayor de 18 a침os para registrarte.');

                try {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) return setError('El usuario ya existe.');

                    const newUser = {
                        fullName: formData.fullName.trim(),
                        username: formData.username,
                        password: formData.password, 
                        dob: formData.dob,
                        role: 'player', 
                        createdAt: serverTimestamp()
                    };
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', formData.username), newUser);
                    alert("Registro exitoso. Por favor inicia sesi칩n.");
                    setMode('login');
                } catch (err) { setError("Error al registrar: " + err.message); }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    const docSnap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username), where('password', '==', formData.password)));
                    if (docSnap.empty) return setError('Credenciales incorrectas.');
                    
                    const userData = docSnap.docs[0].data();
                    setDbUser(userData);
                    setView(userData.role === 'admin' ? 'admin' : 'user');
                } catch (err) { setError("Error de conexi칩n."); console.error(err); }
            };

            const handleRecover = async (e) => {
                e.preventDefault();
                setError('');
                if (formData.newPassword.length < 5) return setError('Nueva contrase침a muy corta.');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', formData.username);
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username), where('dob', '==', formData.dob));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) return setError('Datos no coinciden.');

                    await updateDoc(docRef, { password: formData.newPassword });
                    alert("Contrase침a restablecida.");
                    setMode('login');
                } catch (err) { setError("Error al restablecer."); }
            };

            return (
                <div className="flex justify-center items-center min-h-[70vh] animate-fade-in p-4">
                    <div className="bg-white p-6 md:p-8 rounded-xl shadow-xl w-full max-w-md border">
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">
                                {mode === 'login' ? 'Iniciar Sesi칩n' : mode === 'register' ? 'Registro Nuevo' : 'Restablecer Clave'}
                            </h2>
                            <p className="text-gray-500 text-sm mt-1">Acceso a Quiniela Amigos SICAR</p>
                        </div>

                        <form onSubmit={mode === 'login' ? handleLogin : mode === 'register' ? handleRegister : handleRecover} className="space-y-4">
                            {mode === 'register' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                    <input type="text" required value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value.replace(/[^a-zA-Z치칠칤칩칰츼칄칈칍칔침칌\s]/g, '')})} className="w-full p-3 border rounded-lg" placeholder="Tu nombre real (Solo letras)" />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Usuario</label>
                                <input type="text" required value={formData.username} onChange={e => setFormData({...formData, username: e.target.value.replace(/[^a-zA-Z0-9_]/g, '')})} className="w-full p-3 border rounded-lg" placeholder="Solo letras y n칰meros" />
                            </div>
                            {mode !== 'recover' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Contrase침a</label>
                                    <input type="password" required value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full p-3 border rounded-lg" placeholder="M칤nimo 5 caracteres" />
                                </div>
                            )}
                            {(mode === 'register' || mode === 'recover') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Fecha de Nacimiento {mode === 'register' && '(+18)'}</label>
                                    <input type="date" required value={formData.dob} onChange={e => setFormData({...formData, dob: e.target.value})} className="w-full p-3 border rounded-lg" />
                                </div>
                            )}
                            {mode === 'recover' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Nueva Contrase침a</label>
                                    <input type="password" required value={formData.newPassword} onChange={e => setFormData({...formData, newPassword: e.target.value})} className="w-full p-3 border rounded-lg" />
                                </div>
                            )}
                            {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded flex items-center gap-2"><XCircle size={16}/> {error}</div>}
                            <button type="submit" className="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition shadow-md active:scale-95">
                                {mode === 'login' ? 'Entrar' : mode === 'register' ? 'Registrarse' : 'Cambiar Contrase침a'}
                            </button>
                        </form>
                        <div className="mt-6 text-center space-y-3 text-sm">
                            {mode === 'login' && (
                                <>
                                    <p><button onClick={() => setMode('register')} className="text-blue-600 hover:underline py-1">쯅o tienes cuenta? Reg칤strate</button></p>
                                    <p><button onClick={() => setMode('recover')} className="text-gray-500 hover:underline py-1">Olvid칠 mi contrase침a</button></p>
                                </>
                            )}
                            {(mode === 'register' || mode === 'recover') && (
                                <button onClick={() => setMode('login')} className="text-gray-600 hover:underline py-2">Volver al inicio</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminView({ teams, matchdays, bets, user, appId, db }) {
            const [tab, setTab] = useState('matchdays');
            const tabs = [
                { id: 'matchdays', icon: PlusCircle, label: 'Jornadas' },
                { id: 'approvals', icon: CheckCircle, label: 'Pagos' },
                { id: 'users', icon: Users, label: 'Usuarios' },
                { id: 'results', icon: Trophy, label: 'Resultados' },
                { id: 'teams', icon: Shield, label: 'Equipos' },
                { id: 'player_mode', icon: Gamepad2, label: 'Modo Jugador' },
            ];

            return (
                <div className="bg-white rounded-xl shadow-lg min-h-[80vh] overflow-hidden flex flex-col">
                    <div className="flex border-b overflow-x-auto hide-scrollbar">
                        {tabs.map(t => (
                            <button key={t.id} onClick={() => setTab(t.id)} className={`flex-1 min-w-[90px] py-4 px-2 font-medium flex flex-col md:flex-row justify-center items-center gap-1 md:gap-2 border-b-2 transition whitespace-nowrap ${tab === t.id ? 'border-green-700 text-green-700 bg-green-50' : 'border-transparent text-gray-500'}`}>
                                <t.icon size={20} /> <span className="text-xs md:text-sm">{t.label}</span>
                            </button>
                        ))}
                    </div>
                    <div className="p-4 md:p-6 flex-grow">
                        {tab === 'matchdays' && <AdminMatchdays teams={teams} matchdays={matchdays} appId={appId} db={db} />}
                        {tab === 'approvals' && <AdminApprovals matchdays={matchdays} bets={bets} appId={appId} db={db} />}
                        {tab === 'users' && <AdminUsers appId={appId} db={db} />}
                        {tab === 'results' && <AdminResults matchdays={matchdays} bets={bets} appId={appId} db={db} />}
                        {tab === 'teams' && <AdminTeams teams={teams} appId={appId} db={db} />}
                        {tab === 'player_mode' && (
                            <div className="border-t-4 border-green-500 rounded-lg overflow-hidden">
                                <div className="bg-green-100 p-2 text-center text-green-800 font-bold text-xs uppercase tracking-wide">
                                    Vista de Jugador (Modo Administrador)
                                </div>
                                <UserView teams={teams} matchdays={matchdays} bets={bets} user={user} appId={appId} db={db} />
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function AdminMatchdays({ teams, matchdays, appId, db }) {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');
            const [deadline, setDeadline] = useState('');
            const [matches, setMatches] = useState([{ home: '', away: '' }]);

            const getAvailableTeams = (currentRowIdx, currentSide) => {
                const usedInOtherRows = matches.flatMap((m, idx) => idx !== currentRowIdx ? [m.home, m.away] : []).filter(Boolean);
                const currentOpponent = currentSide === 'home' ? matches[currentRowIdx].away : matches[currentRowIdx].home;
                const blocked = [...usedInOtherRows];
                if (currentOpponent) blocked.push(currentOpponent);
                return teams.filter(t => !blocked.includes(t.name));
            };

            const updateMatch = (idx, field, val) => {
                const newMatches = [...matches];
                newMatches[idx][field] = val;
                setMatches(newMatches);
            };

            const handleCreate = async () => {
                if (!name || !price || !deadline || matches.some(m => !m.home || !m.away)) return alert("Completa todos los campos, incluyendo la fecha l칤mite.");
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'matchdays'), {
                    name, price: Number(price), deadline: deadline, matches: matches.map((m, i) => ({ ...m, id: i, result: null })), status: 'active', createdAt: serverTimestamp()
                });
                setName(''); setPrice(''); setDeadline(''); setMatches([{ home: '', away: '' }]);
                alert("Jornada Publicada");
            };

            return (
                <div className="grid lg:grid-cols-2 gap-8">
                    <div>
                        <h3 className="text-xl font-bold mb-4">Nueva Jornada</h3>
                        <div className="space-y-4">
                            <input value={name} onChange={e => setName(e.target.value)} placeholder="Nombre (ej. Jornada 5)" className="w-full p-3 border rounded-lg" />
                            <div className="grid grid-cols-2 gap-4">
                                <input type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="Costo ($)" className="w-full p-3 border rounded-lg" />
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1 ml-1">Fecha L칤mite</label>
                                    <input type="datetime-local" value={deadline} onChange={e => setDeadline(e.target.value)} className="w-full p-3 border rounded-lg text-sm" />
                                </div>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded-lg border space-y-4">
                                <label className="font-bold text-sm text-gray-700 block mb-2">Encuentros</label>
                                {matches.map((m, i) => (
                                    <div key={i} className="flex flex-col md:flex-row gap-2 items-center bg-white p-2 rounded shadow-sm md:shadow-none md:bg-transparent border md:border-0">
                                        <select className="w-full md:flex-1 p-2 border rounded text-sm bg-white" value={m.home} onChange={e => updateMatch(i, 'home', e.target.value)}>
                                            <option value="">Local</option>
                                            {getAvailableTeams(i, 'home').map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                            {m.home && !getAvailableTeams(i, 'home').find(t=>t.name===m.home) && <option value={m.home}>{m.home}</option>}
                                        </select>
                                        
                                        <span className="font-bold text-gray-400 text-xs md:text-base">VS</span>
                                        
                                        <select className="w-full md:flex-1 p-2 border rounded text-sm bg-white" value={m.away} onChange={e => updateMatch(i, 'away', e.target.value)}>
                                            <option value="">Visitante</option>
                                            {getAvailableTeams(i, 'away').map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                            {m.away && !getAvailableTeams(i, 'away').find(t=>t.name===m.away) && <option value={m.away}>{m.away}</option>}
                                        </select>
                                        
                                        <button onClick={() => setMatches(matches.filter((_, idx) => idx !== i))} className="w-full md:w-auto text-red-500 hover:bg-red-50 p-2 rounded border md:border-0 flex justify-center"><X size={16}/></button>
                                    </div>
                                ))}
                                <button onClick={() => setMatches([...matches, { home: '', away: '' }])} className="text-green-600 text-sm font-bold flex items-center gap-1 mt-2 p-2 hover:bg-green-50 rounded w-full md:w-auto"><PlusCircle size={14}/> Agregar Encuentro</button>
                            </div>
                            
                            <button onClick={handleCreate} className="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 shadow-lg active:scale-95 transition">Publicar Jornada</button>
                        </div>
                    </div>
                    
                    <div className="border-l-0 border-t pt-6 lg:pt-0 lg:border-t-0 lg:border-l pl-0 lg:pl-8">
                        <h3 className="text-xl font-bold mb-4">Jornadas Activas</h3>
                        <div className="space-y-3 max-h-[500px] overflow-y-auto">
                            {matchdays.map(m => (
                                <div key={m.id} className="p-4 border rounded bg-white shadow-sm">
                                    <div className="flex justify-between items-start">
                                        <div className="overflow-hidden">
                                            <h4 className="font-bold truncate">{m.name}</h4>
                                            {m.deadline && <p className="text-xs text-red-500 flex items-center gap-1 mt-1"><Clock size={12}/> {new Date(m.deadline).toLocaleString()}</p>}
                                        </div>
                                        <button onClick={async () => { if(confirm("쮼liminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matchdays', m.id)); }} className="text-red-400 text-xs hover:text-red-600 ml-2">Eliminar</button>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-2">{m.matches.length} partidos - ${m.price}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminUsers({ appId, db }) {
            const [users, setUsers] = useState([]);
            useEffect(() => { const unsub = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'users')), (s) => setUsers(s.docs.map(d => ({ id: d.id, ...d.data() })))); return () => unsub(); }, []);
            const toggleRole = async (u) => { if (confirm(`쮺ambiar rol?`)) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { role: u.role === 'admin' ? 'player' : 'admin' }); };
            const handleDeleteUser = async (u) => { if (confirm(`쮼liminar a ${u.username}?`)) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id)); };

            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Usuarios</h3>
                    <div className="overflow-x-auto bg-white rounded shadow border">
                        <table className="w-full text-left whitespace-nowrap">
                            <thead className="bg-gray-100 text-gray-600 text-sm"><tr><th className="p-3">Nombre</th><th className="p-3">Usuario</th><th className="p-3">Rol</th><th className="p-3">Acciones</th></tr></thead>
                            <tbody className="divide-y text-sm">
                                {users.map(u => (
                                    <tr key={u.id}>
                                        <td className="p-3 font-medium capitalize">{u.fullName || '-'}</td>
                                        <td className="p-3 text-gray-600">{u.username}</td>
                                        <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>{u.role === 'admin' ? 'ADMIN' : 'JUGADOR'}</span></td>
                                        <td className="p-3 flex gap-2">
                                            <button onClick={() => toggleRole(u)} className="p-1 border rounded"><RefreshCw size={14}/></button>
                                            <button onClick={() => handleDeleteUser(u)} className="p-1 border border-red-200 text-red-600 rounded"><Trash2 size={14}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function AdminApprovals({ matchdays, bets, appId, db }) {
            const togglePay = async (b) => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bets', b.id), { status: b.status === 'pending' ? 'paid' : 'pending' });
            const delBet = async (b) => { if(confirm("쮼liminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bets', b.id)); };
            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Pagos</h3>
                    <div className="overflow-x-auto bg-white rounded border">
                        <table className="w-full text-left text-sm whitespace-nowrap">
                            <thead className="bg-gray-100 text-gray-600"><tr><th className="p-3">Usuario</th><th className="p-3">Jornada</th><th className="p-3">Ref</th><th className="p-3">Estado</th><th className="p-3">Acci칩n</th></tr></thead>
                            <tbody className="divide-y">
                                {bets.map(b => {
                                    const m = matchdays.find(md => md.id === b.matchdayId);
                                    return (
                                        <tr key={b.id}>
                                            <td className="p-3 font-medium">{b.userName}</td>
                                            <td className="p-3">{m ? m.name : '???'}</td>
                                            <td className="p-3 font-mono text-xs">{b.paymentRef}</td>
                                            <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${b.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>{b.status === 'paid'?'OK':'PEND'}</span></td>
                                            <td className="p-3 flex gap-2"><button onClick={() => togglePay(b)} className="text-xs border px-2 py-1 rounded">Cambiar</button><button onClick={() => delBet(b)} className="text-red-500"><Trash2 size={14}/></button></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function AdminTeams({ teams, appId, db }) {
            const [newTeam, setNewTeam] = useState('');
            const handleAdd = async (e) => { e.preventDefault(); if(!newTeam.trim()) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), { name: newTeam.trim() }); setNewTeam(''); };
            const handleDelete = async (id) => { if(confirm("쮹orrar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', id)); };
            return (
                <div className="max-w-xl mx-auto">
                    <h3 className="text-xl font-bold mb-4">Equipos</h3>
                    <form onSubmit={handleAdd} className="flex gap-2 mb-4"><input value={newTeam} onChange={e => setNewTeam(e.target.value)} placeholder="Nombre" className="flex-1 p-2 border rounded" /><button className="bg-green-600 text-white px-4 rounded">Add</button></form>
                    <ul className="border rounded divide-y max-h-80 overflow-y-auto">{teams.map(t => <li key={t.id} className="p-3 flex justify-between"><span>{t.name}</span><button onClick={() => handleDelete(t.id)} className="text-red-500"><Trash2 size={14}/></button></li>)}</ul>
                </div>
            );
        }

        function AdminResults({ matchdays, bets, appId, db }) {
            const [selId, setSelId] = useState('');
            const [res, setRes] = useState({});
            const m = matchdays.find(x => x.id === selId);
            const leaderboard = useMemo(() => {
                if (!m) return [];
                const matchdayBets = bets.filter(b => b.matchdayId === m.id);
                return matchdayBets.map(bet => {
                    let points = 0;
                    bet.predictions.forEach(pred => {
                        const match = m.matches.find(match => match.id === pred.matchId);
                        const currentResult = res[pred.matchId] || match?.result;
                        if (currentResult && currentResult === pred.prediction) points++;
                    });
                    return { ...bet, points };
                }).sort((a, b) => b.points - a.points);
            }, [m, bets, res]);
            
            const save = async () => { if(!m || !confirm("쮽inalizar?")) return; const updated = m.matches.map(match => ({ ...match, result: res[match.id] || null })); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matchdays', m.id), { matches: updated, status: 'finalized' }); alert("Guardado"); };
            useEffect(() => { if(m && m.matches) { const loadedRes = {}; m.matches.forEach(match => { if(match.result) loadedRes[match.id] = match.result; }); setRes(loadedRes); } else { setRes({}); } }, [m]);

            return (
                <div className="grid lg:grid-cols-2 gap-8">
                    <div>
                        <h3 className="text-xl font-bold mb-4">Captura</h3>
                        <select className="w-full p-2 border rounded mb-6" value={selId} onChange={e => setSelId(e.target.value)}><option value="">Selecciona Jornada</option>{matchdays.filter(x => x.status !== 'deleted').map(x => <option key={x.id} value={x.id}>{x.name}</option>)}</select>
                        {m && (
                            <div className="bg-gray-50 p-4 rounded border">
                                <h4 className="font-bold text-center mb-4">{m.name}</h4>
                                <div className="space-y-3 mb-6">
                                    {m.matches.map(match => (
                                        <div key={match.id} className="flex flex-col md:flex-row justify-between items-center bg-white p-2 rounded border gap-2">
                                            <span className="w-full md:w-1/3 text-center md:text-right text-sm font-medium">{match.home}</span>
                                            <div className="flex gap-1 justify-center">
                                                {['L','E','V'].map(opt => {
                                                    const val = opt === 'L' ? 'local' : opt === 'E' ? 'tie' : 'visit';
                                                    return <button key={opt} onClick={() => setRes({...res, [match.id]: val})} className={`w-8 h-8 rounded text-xs font-bold transition ${res[match.id] === val ? 'bg-green-600 text-white' : 'bg-gray-100'}`}>{opt}</button>
                                                })}
                                            </div>
                                            <span className="w-full md:w-1/3 text-center md:text-left text-sm font-medium">{match.away}</span>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={save} className="w-full bg-blue-600 text-white py-3 rounded font-bold shadow">Guardar Resultados</button>
                            </div>
                        )}
                    </div>
                    <div className="border-t pt-6 lg:pt-0 lg:border-t-0 lg:border-l pl-0 lg:pl-8">
                        <h3 className="text-xl font-bold mb-4">Ranking</h3>
                        {leaderboard.length > 0 ? (
                            <div className="bg-white rounded border overflow-hidden">
                                {leaderboard.map((bet, idx) => (
                                    <div key={bet.id} className={`flex justify-between items-center p-3 text-sm border-b ${idx===0?'bg-yellow-50':''}`}>
                                        <span className={`w-8 font-bold text-center ${idx===0?'text-yellow-600':''}`}>{idx+1}</span>
                                        <span className="flex-1 px-2 truncate">{bet.userName}</span>
                                        <span className="font-bold text-blue-700">{bet.points} pts</span>
                                    </div>
                                ))}
                            </div>
                        ) : <p className="text-gray-400 text-center">Sin datos</p>}
                    </div>
                </div>
            );
        }

        function UserView({ teams, matchdays, bets, user, appId, db }) {
            const [tab, setTab] = useState('play');
            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow overflow-hidden flex flex-col h-full md:h-auto">
                    <div className="flex border-b overflow-x-auto hide-scrollbar">
                        <button onClick={() => setTab('play')} className={`flex-1 py-4 px-4 font-bold whitespace-nowrap ${tab === 'play' ? 'text-green-700 bg-green-50 border-b-2 border-green-700' : 'text-gray-500'}`}>Jugar</button>
                        <button onClick={() => setTab('history')} className={`flex-1 py-4 px-4 font-bold whitespace-nowrap ${tab === 'history' ? 'text-green-700 bg-green-50 border-b-2 border-green-700' : 'text-gray-500'}`}>Mis Quinielas</button>
                        <button onClick={() => setTab('results')} className={`flex-1 py-4 px-4 font-bold whitespace-nowrap ${tab === 'results' ? 'text-green-700 bg-green-50 border-b-2 border-green-700' : 'text-gray-500'}`}>Resultados</button>
                    </div>
                    <div className="p-4 md:p-6 flex-grow">
                        {tab === 'play' && <UserPlay matchdays={matchdays} user={user} bets={bets} appId={appId} db={db} />}
                        {tab === 'history' && <UserHistory matchdays={matchdays} user={user} bets={bets} />}
                        {tab === 'results' && <UserResults matchdays={matchdays} bets={bets} user={user} />}
                    </div>
                </div>
            );
        }

        function UserResults({ matchdays, bets, user }) {
            const [filterDateStart, setFilterDateStart] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 10);
                return d.toISOString().split('T')[0];
            });
            const [filterDateEnd, setFilterDateEnd] = useState(new Date().toISOString().split('T')[0]);

            const finalized = useMemo(() => {
                return matchdays.filter(m => {
                    if (m.status !== 'finalized') return false;
                    // Filtro de fecha usando 'deadline' como referencia de cuando ocurri칩 la jornada
                    if (!m.deadline) return true; 
                    const d = new Date(m.deadline);
                    const start = new Date(filterDateStart);
                    const end = new Date(filterDateEnd);
                    end.setHours(23, 59, 59, 999); // Final del d칤a
                    return d >= start && d <= end;
                });
            }, [matchdays, filterDateStart, filterDateEnd]);

            const [selId, setSelId] = useState('');
            
            // Actualizar selId si la lista filtrada cambia y el seleccionado ya no est치 o es vac칤o
            useEffect(() => {
                if (finalized.length > 0) {
                     // Si no hay seleccionado o el seleccionado ya no est치 en la lista filtrada
                    if (!selId || !finalized.find(f => f.id === selId)) {
                        setSelId(finalized[0].id);
                    }
                } else {
                    setSelId('');
                }
            }, [finalized, selId]);

            const m = matchdays.find(x => x.id === selId);

            const leaderboard = useMemo(() => {
                if (!m) return [];
                const matchdayBets = bets.filter(b => b.matchdayId === m.id && b.status === 'paid');
                return matchdayBets.map(bet => {
                    let points = 0;
                    bet.predictions.forEach(pred => {
                        const match = m.matches.find(match => match.id === pred.matchId);
                        if (match?.result && match.result === pred.prediction) points++;
                    });
                    return { ...bet, points };
                }).sort((a, b) => b.points - a.points);
            }, [m, bets]);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg border shadow-sm">
                        <div className="flex flex-col md:flex-row gap-4 mb-4">
                             <div className="flex-1">
                                <label className="block text-xs font-bold text-gray-500 mb-1">Desde</label>
                                <input type="date" value={filterDateStart} onChange={e => setFilterDateStart(e.target.value)} className="w-full p-2 border rounded text-sm"/>
                             </div>
                             <div className="flex-1">
                                <label className="block text-xs font-bold text-gray-500 mb-1">Hasta</label>
                                <input type="date" value={filterDateEnd} onChange={e => setFilterDateEnd(e.target.value)} className="w-full p-2 border rounded text-sm"/>
                             </div>
                        </div>

                        <label className="block text-sm font-bold text-gray-700 mb-2">Seleccionar Jornada Finalizada</label>
                        <select className="w-full p-2 border rounded bg-gray-50" value={selId} onChange={e => setSelId(e.target.value)} disabled={finalized.length === 0}>
                            {finalized.length > 0 ? (
                                finalized.map(f => <option key={f.id} value={f.id}>{f.name}</option>)
                            ) : (
                                <option value="">Sin jornadas en este rango</option>
                            )}
                        </select>
                    </div>

                    {m ? (
                        <div className="grid md:grid-cols-2 gap-4">
                            <div className="bg-white rounded-lg border shadow-sm overflow-hidden">
                                <div className="bg-gray-100 p-3 border-b font-bold text-gray-700 flex items-center gap-2">
                                    <CheckCircle size={18} className="text-green-600"/> Resultados Oficiales
                                </div>
                                <div className="p-4 space-y-2">
                                    {m.matches.map(match => (
                                        <div key={match.id} className="flex items-center text-sm border-b last:border-0 pb-2 last:pb-0">
                                            <span className={`flex-1 text-right ${match.result === 'local' ? 'font-bold text-green-700' : 'text-gray-600'}`}>{match.home}</span>
                                            <div className="mx-3 flex gap-1">
                                                <span className={`w-6 h-6 flex items-center justify-center rounded text-xs font-bold ${match.result === 'local' ? 'bg-green-600 text-white shadow' : 'bg-gray-100 text-gray-300'}`}>L</span>
                                                <span className={`w-6 h-6 flex items-center justify-center rounded text-xs font-bold ${match.result === 'tie' ? 'bg-green-600 text-white shadow' : 'bg-gray-100 text-gray-300'}`}>E</span>
                                                <span className={`w-6 h-6 flex items-center justify-center rounded text-xs font-bold ${match.result === 'visit' ? 'bg-green-600 text-white shadow' : 'bg-gray-100 text-gray-300'}`}>V</span>
                                            </div>
                                            <span className={`flex-1 text-left ${match.result === 'visit' ? 'font-bold text-green-700' : 'text-gray-600'}`}>{match.away}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-white rounded-lg border shadow-sm overflow-hidden">
                                <div className="bg-yellow-50 p-3 border-b font-bold text-yellow-800 flex items-center gap-2">
                                    <Trophy size={18} className="text-yellow-600"/> Tabla de Ganadores
                                </div>
                                <div className="max-h-[400px] overflow-y-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-gray-500 bg-gray-50 sticky top-0">
                                            <tr>
                                                <th className="p-2 w-10 text-center">#</th>
                                                <th className="p-2">Jugador</th>
                                                <th className="p-2 text-right">Aciertos</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {leaderboard.map((bet, idx) => {
                                                const isMe = bet.userName === user.username;
                                                const medal = idx === 0 ? '游볞' : idx === 1 ? '游볟' : idx === 2 ? '游볠' : (idx + 1);
                                                return (
                                                    <tr key={bet.id} className={`${isMe ? 'bg-green-50' : 'hover:bg-gray-50'} transition`}>
                                                        <td className="p-2 font-bold text-center text-lg md:text-base">{medal}</td>
                                                        <td className="p-2">
                                                            <div className={`font-medium truncate max-w-[120px] ${isMe ? 'text-green-800' : 'text-gray-800'}`}>{bet.userFullName || bet.userName}</div>
                                                            {isMe && <span className="text-[10px] text-green-600 font-bold uppercase tracking-wider">춰Eres t칰!</span>}
                                                        </td>
                                                        <td className="p-2 text-right font-bold text-blue-600 text-lg md:text-base">{bet.points}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                    {leaderboard.length === 0 && <p className="p-8 text-center text-gray-400 text-xs italic">Nadie ha participado (o pagado) en esta jornada a칰n.</p>}
                                </div>
                            </div>
                        </div>
                    ) : (
                         <div className="text-center p-8 text-gray-400 italic flex flex-col items-center gap-2"><Trophy size={48} className="text-gray-200"/> {finalized.length === 0 ? "No hay resultados en estas fechas." : "Selecciona una jornada."}</div>
                    )}
                </div>
            );
        }

        function UserPlay({ matchdays, user, bets, appId, db }) {
            const [selM, setSelM] = useState(null);
            const [preds, setPreds] = useState({});
            const [paymentRef, setPaymentRef] = useState('');
            const [submitting, setSubmitting] = useState(false);
            const [viewParticipantsId, setViewParticipantsId] = useState(null);
            const active = matchdays.filter(m => m.status === 'active');

            const submit = async () => {
                if(!selM.matches.every(m => preds[m.id])) return alert("Completa todos los partidos");
                if(!paymentRef.trim()) return alert("Ingresa referencia de pago");
                setSubmitting(true);
                try {
                    const onlineTime = await getTrustedTime();
                    if (onlineTime > new Date(selM.deadline)) { alert("Tiempo agotado"); setSubmitting(false); return; }
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bets'), {
                        matchdayId: selM.id, userName: user.username, userFullName: user.fullName || user.username, predictions: Object.entries(preds).map(([k,v]) => ({ matchId: parseInt(k), prediction: v })), paymentRef: paymentRef.trim(), status: 'pending', createdAt: serverTimestamp()
                    });
                    alert("Enviado!"); setSelM(null); setPreds({}); setPaymentRef('');
                } catch (e) { alert("Error"); } finally { setSubmitting(false); }
            };

            if (selM) return (
                <div>
                    <button onClick={() => setSelM(null)} className="text-sm font-bold text-gray-500 mb-4 flex items-center gap-1"><ChevronDown className="rotate-90" size={16}/> Volver</button>
                    <div className="text-center mb-6">
                        <h3 className="text-2xl font-bold mb-1">{selM.name}</h3>
                        <p className="text-green-700 font-bold">Costo: ${selM.price}</p>
                    </div>
                    <div className="space-y-4 max-w-2xl mx-auto mb-6">
                        {selM.matches.map(m => (
                            <div key={m.id} className="bg-gray-50 p-3 rounded flex flex-col md:flex-row justify-between items-center border gap-3 md:gap-0">
                                <span className="w-full md:flex-1 text-center md:text-right font-bold text-sm md:text-base">{m.home}</span>
                                <div className="flex gap-2 mx-4 justify-center">
                                    {['L','E','V'].map(opt => {
                                        const val = opt === 'L' ? 'local' : opt === 'E' ? 'tie' : 'visit';
                                        return <button key={opt} onClick={() => setPreds({...preds, [m.id]: val})} className={`w-12 h-10 md:w-10 md:h-10 rounded-lg md:rounded-full font-bold border transition ${preds[m.id] === val ? 'bg-green-600 text-white scale-110' : 'bg-white text-gray-400'}`}>{opt}</button>
                                    })}
                                </div>
                                <span className="w-full md:flex-1 text-center md:text-left font-bold text-sm md:text-base">{m.away}</span>
                            </div>
                        ))}
                    </div>
                    <div className="max-w-2xl mx-auto">
                        <input type="text" value={paymentRef} onChange={e => setPaymentRef(e.target.value)} placeholder="Ref. Pago / Folio" className="w-full p-3 border rounded-lg bg-yellow-50 mb-4" />
                        <button onClick={submit} disabled={submitting} className={`w-full text-white py-3 rounded-lg font-bold shadow ${submitting?'bg-gray-400':'bg-green-600 hover:bg-green-700'}`}>{submitting?'Enviando...':'Enviar Quiniela'}</button>
                    </div>
                </div>
            );

            return (
                <div className="grid gap-4 md:grid-cols-2">
                    {active.map(m => {
                        const played = bets.some(b => b.userName === user.username && b.matchdayId === m.id);
                        const isExpired = m.deadline && new Date() > new Date(m.deadline);
                        const paidBets = bets.filter(b => b.matchdayId === m.id && b.status === 'paid');
                        return (
                            <div key={m.id} className={`border p-5 rounded-lg relative overflow-hidden flex flex-col ${isExpired ? 'bg-gray-50' : 'bg-white shadow-sm'}`}>
                                {isExpired && <div className="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl">CERRADA</div>}
                                <h3 className="font-bold text-xl text-green-800 mb-1">{m.name}</h3>
                                <div className="flex items-center gap-2 mb-3"><span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1"><Banknote size={12}/> Bolsa: ${paidBets.length * m.price}</span></div>
                                <div className="text-sm text-gray-500 mb-4 space-y-1">
                                    <p>{m.matches.length} partidos - ${m.price}</p>
                                    {m.deadline && <p className={`flex items-center gap-1 ${isExpired?'text-red-500':'text-orange-500'}`}><Clock size={12}/> {new Date(m.deadline).toLocaleString()}</p>}
                                </div>
                                <div className="mt-auto space-y-3">
                                    <button onClick={() => setViewParticipantsId(viewParticipantsId === m.id ? null : m.id)} className="w-full text-blue-600 text-xs font-bold flex items-center justify-center gap-1 py-2 border rounded border-blue-100"><Users size={14}/> {paidBets.length} Participantes {viewParticipantsId===m.id?<ChevronUp size={12}/>:<ChevronDown size={12}/>}</button>
                                    {viewParticipantsId === m.id && <ul className="bg-blue-50 p-2 rounded text-xs text-gray-700 max-h-32 overflow-y-auto">{paidBets.map(b=><li key={b.id} className="truncate"> {b.userFullName||b.userName}</li>)}</ul>}
                                    <button onClick={() => !played && !isExpired && setSelM(m)} disabled={played || isExpired} className={`w-full py-2 rounded font-bold ${played||isExpired?'bg-gray-200 text-gray-400':'bg-green-600 text-white'}`}>{played?'Jugado':isExpired?'Cerrada':'Jugar'}</button>
                                </div>
                            </div>
                        );
                    })}
                    {active.length === 0 && <p className="text-center text-gray-400 col-span-2 py-10">Sin jornadas</p>}
                </div>
            );
        }

        function UserHistory({ matchdays, user, bets }) {
            const [printBet, setPrintBet] = useState(null);
            const [filter, setFilter] = useState('all'); // all, active, finished, unpaid

            const filteredBets = useMemo(() => {
                const myBets = bets.filter(b => b.userName === user.username);
                const now = new Date();
                
                return myBets.filter(b => {
                    const m = matchdays.find(md => md.id === b.matchdayId);
                    if (!m) return false;
                    
                    const isExpired = m.deadline && now > new Date(m.deadline);
                    const isFinalized = m.status === 'finalized';
                    const isPaid = b.status === 'paid';

                    if (filter === 'active') return !isExpired && !isFinalized;
                    if (filter === 'finished') return isExpired || isFinalized;
                    if (filter === 'unpaid') return !isPaid;
                    
                    return true;
                }).sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
            }, [bets, matchdays, user, filter]);

            // --- DISE칌O DE VISTA PREVIA Y MODAL DE IMPRESI칍N ---
            if (printBet) {
                const m = matchdays.find(md => md.id === printBet.matchdayId);
                return (
                    <div className="fixed inset-0 bg-black/80 z-[9999] flex justify-center items-center p-4 print:p-0 print:bg-white print:items-start print:static">
                        <div className="bg-white w-full max-w-md rounded-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh] print:shadow-none print:max-h-none print:w-full print:overflow-visible">
                            
                            {/* Toolbar de Acciones (No Imprimible) */}
                            <div className="bg-gray-900 text-white p-4 flex justify-between items-center no-print shrink-0">
                                <h3 className="font-bold text-lg flex items-center gap-2"><Trophy size={20} className="text-yellow-400"/> Ticket</h3>
                                <div className="flex gap-2">
                                    <button onClick={() => window.print()} className="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition shadow-lg">
                                        <Printer size={18}/> Descargar / Imprimir
                                    </button>
                                    <button onClick={() => setPrintBet(null)} className="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg transition" title="Cerrar">
                                        <X size={20}/>
                                    </button>
                                </div>
                            </div>

                            {/* 츼rea del Ticket (Scrollable en pantalla) */}
                            <div className="overflow-y-auto bg-gray-100 flex-1 flex flex-col items-center print:p-0 print:bg-white print:overflow-visible print:block">
                                {/* Wrapper para margen visual en pantalla */}
                                <div className="my-8 print:m-0">
                                    <div id="printable-ticket" className="w-[350px] bg-white border-2 border-dashed border-gray-800 p-6 text-black shadow-sm print:shadow-none print:border-gray-800 print:w-full print:max-w-[400px] print:mx-auto relative">
                                        {/* Header */}
                                        <div className="text-center border-b-2 border-black pb-4 mb-4">
                                            <div className="flex justify-center mb-2"><Trophy size={32} className="text-black"/></div>
                                            <h1 className="text-xl font-black uppercase tracking-wider">Quiniela SICAR</h1>
                                            <p className="text-xs font-mono mt-1 text-gray-500">{new Date().toLocaleString()}</p>
                                        </div>
                                        
                                        {/* Details */}
                                        <div className="mb-6 text-sm space-y-2 font-mono">
                                            <div className="flex justify-between border-b border-gray-100 pb-1">
                                                <span className="text-gray-500">Jornada:</span>
                                                <span className="font-bold truncate max-w-[150px]">{m?.name}</span>
                                            </div>
                                            <div className="flex justify-between border-b border-gray-100 pb-1">
                                                <span className="text-gray-500">Jugador:</span>
                                                <span className="font-bold uppercase truncate max-w-[150px]">{printBet.userFullName || printBet.userName}</span>
                                            </div>
                                            <div className="flex justify-between border-b border-gray-100 pb-1">
                                                <span className="text-gray-500">Ref. Pago:</span>
                                                <span className="font-bold">{printBet.paymentRef}</span>
                                            </div>
                                        </div>

                                        {/* Matrix */}
                                        <div className="mb-6">
                                            <div className="flex text-[10px] font-bold text-gray-400 mb-2 border-b-2 border-gray-800 pb-1">
                                                <span className="flex-1">PARTIDO</span>
                                                <span className="w-6 text-center">L</span>
                                                <span className="w-6 text-center">E</span>
                                                <span className="w-6 text-center">V</span>
                                            </div>
                                            {printBet.predictions.map((p, i) => {
                                                const match = m?.matches.find(ma => ma.id === p.matchId);
                                                if (!match) return null;
                                                return (
                                                    <div key={i} className="flex items-center text-xs py-2 border-b border-gray-100">
                                                        <div className="flex-1 pr-2 leading-tight">
                                                            <div className="font-bold">{match.home}</div>
                                                            <div className="text-[10px] text-gray-500">vs {match.away}</div>
                                                        </div>
                                                        <div className="flex gap-0">
                                                            {['local', 'tie', 'visit'].map(opt => {
                                                                const isSelected = p.prediction === opt;
                                                                return (
                                                                    <div key={opt} className="w-6 flex justify-center items-center">
                                                                        {isSelected ? (
                                                                            <div className="w-5 h-5 bg-black text-white rounded-full flex items-center justify-center print:bg-black print:text-white">
                                                                                <Check size={12} strokeWidth={4} />
                                                                            </div>
                                                                        ) : (
                                                                            <div className="w-5 h-5 rounded-full border border-gray-300"></div>
                                                                        )}
                                                                    </div>
                                                                )
                                                            })}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {/* Footer Status */}
                                        <div className="text-center border-t-2 border-black pt-4">
                                            <div className="inline-block border-2 border-black px-4 py-1 rounded font-black text-lg uppercase tracking-widest">
                                                {printBet.status === 'paid' ? 'PAGADO' : 'PENDIENTE'}
                                            </div>
                                            <p className="text-[10px] text-gray-400 mt-2">춰Mucha Suerte!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    {/* Filtros de Pesta침as */}
                    <div className="flex gap-2 mb-4 overflow-x-auto pb-2 hide-scrollbar">
                        {[
                            { id: 'all', label: 'Todas', icon: FileText },
                            { id: 'active', label: 'Activas', icon: CheckCircle },
                            { id: 'finished', label: 'Vencidas', icon: Trophy },
                            { id: 'unpaid', label: 'Falta Pago', icon: AlertTriangle }
                        ].map(f => (
                            <button 
                                key={f.id} 
                                onClick={() => setFilter(f.id)} 
                                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition ${filter === f.id ? 'bg-green-700 text-white border-green-700 shadow-md' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}`}
                            >
                                <f.icon size={14}/> {f.label}
                            </button>
                        ))}
                    </div>

                    <div className="space-y-4">
                        {filteredBets.length === 0 ? (
                            <p className="text-center text-gray-400 text-sm py-10 italic">No se encontraron quinielas con este filtro.</p>
                        ) : (
                            filteredBets.map(b => {
                                const m = matchdays.find(md => md.id === b.matchdayId);
                                const points = m?.status === 'finalized' ? b.predictions.filter(p => m.matches.find(ma => ma.id === p.matchId)?.result === p.prediction).length : null;
                                const isExpired = m && m.deadline && new Date() > new Date(m.deadline);
                                const isFinalized = m && m.status === 'finalized';
                                const isActive = !isExpired && !isFinalized;

                                return (
                                    <div key={b.id} className="border p-4 rounded-lg flex justify-between items-center bg-gray-50 hover:bg-white transition hover:shadow-sm">
                                        <div>
                                            <h4 className="font-bold text-gray-800">{m?.name}</h4>
                                            
                                            {/* Badges de Estado */}
                                            <div className="flex flex-wrap gap-2 mt-2">
                                                {/* Badge de Pago */}
                                                <span className={`text-[10px] px-2 py-0.5 rounded border font-bold ${b.status === 'paid' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-yellow-50 text-yellow-700 border-yellow-200'}`}>
                                                    {b.status === 'paid' ? 'PAGO OK' : 'PAGO PENDIENTE'}
                                                </span>

                                                {/* Badge de Tiempo/Estado */}
                                                {isActive && (
                                                    <span className="text-[10px] px-2 py-0.5 rounded border font-bold bg-blue-50 text-blue-700 border-blue-200 flex items-center gap-1">
                                                        <Clock size={10}/> ACTIVA
                                                    </span>
                                                )}
                                                {(isExpired || isFinalized) && (
                                                    <span className="text-[10px] px-2 py-0.5 rounded border font-bold bg-gray-100 text-gray-500 border-gray-200 flex items-center gap-1">
                                                        {isFinalized ? <Trophy size={10}/> : <Lock size={10}/>} {isFinalized ? 'FINALIZADA' : 'VENCIDA'}
                                                    </span>
                                                )}

                                                {/* Badge de Puntos (si aplica) */}
                                                {points !== null && (
                                                    <span className="text-[10px] px-2 py-0.5 rounded border font-bold bg-purple-50 text-purple-700 border-purple-200">
                                                        {points} Aciertos
                                                    </span>
                                                )}
                                            </div>

                                            <p className="text-[10px] text-gray-400 mt-1 font-mono">Ref: {b.paymentRef}</p>
                                        </div>
                                        <button onClick={() => setPrintBet(b)} className="text-gray-500 hover:text-green-600 flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-gray-100 transition" title="Ver Ticket">
                                            <Printer size={20}/>
                                            <span className="text-[10px] font-bold">Ticket</span>
                                        </button>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
