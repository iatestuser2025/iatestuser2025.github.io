<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiniela Amigos SICAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, setDoc, getDocs, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { Trophy, Users, PlusCircle, CheckCircle, Clock, Search, FileText, LogOut, Shield, User, Printer, XCircle, Menu, X, Lock, RefreshCw, KeyRound, Calendar, Trash2, AlertTriangle, Banknote } from 'https://esm.sh/lucide-react@0.263.1';

        // --- CONFIGURACIÓN FIREBASE (PROYECTO EXISTENTE) ---
        const localConfig = {
          apiKey: "AIzaSyA6uydlodXo1vnyqoocwzHytwt5W0riIDQ",
          authDomain: "blackjack-d6b7b.firebaseapp.com",
          projectId: "blackjack-d6b7b",
          storageBucket: "blackjack-d6b7b.appspot.com",
          messagingSenderId: "705363226577",
          appId: "1:705363226577:web:214cf8baa2c9fb48e73af0"
        };

        let firebaseConfig;
        let appId = 'default-app-id';
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } else {
                firebaseConfig = localConfig;
            }
        } catch (e) { console.error(e); }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UTILERIAS DE TIEMPO ---
        const getTrustedTime = async () => {
            try {
                const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
                const data = await response.json();
                return new Date(data.utc_datetime); 
            } catch (error) {
                console.warn("Fallo al consultar hora online, usando fallback local:", error);
                return new Date(); 
            }
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [authUser, setAuthUser] = useState(null); 
            const [dbUser, setDbUser] = useState(null);     
            const [view, setView] = useState('auth');       
            const [teams, setTeams] = useState([]);
            const [matchdays, setMatchdays] = useState([]);
            const [bets, setBets] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setAuthUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!authUser) return;
                
                const unsubTeams = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'teams')), (s) => {
                    setTeams(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name)));
                });
                const unsubMatchdays = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'matchdays')), (s) => {
                    setMatchdays(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                });
                const unsubBets = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'bets')), (s) => {
                    setBets(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                return () => { unsubTeams(); unsubMatchdays(); unsubBets(); };
            }, [authUser]);

            const handleLogout = () => {
                setDbUser(null);
                setView('auth');
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-green-700 font-bold">Cargando...</div>;

            return (
                <div className="min-h-screen flex flex-col bg-gray-50">
                    <nav className="bg-green-700 text-white shadow-lg p-4 sticky top-0 z-50 no-print">
                        <div className="container mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Trophy className="text-yellow-300" />
                                <span className="font-bold text-xl">Quiniela Amigos SICAR</span>
                            </div>
                            {dbUser && (
                                <div className="flex items-center gap-4">
                                    <span className="hidden md:inline text-sm opacity-90 font-medium capitalize">
                                        {/* Muestra Nombre real si existe, sino el usuario */}
                                        {dbUser.fullName || dbUser.username} ({dbUser.role === 'admin' ? 'ADMIN' : 'JUGADOR'})
                                    </span>
                                    <button onClick={handleLogout} className="hover:bg-green-600 p-2 rounded-full transition" title="Cerrar Sesión">
                                        <LogOut size={20} />
                                    </button>
                                </div>
                            )}
                        </div>
                    </nav>

                    <main className="container mx-auto p-4 md:p-6 mb-20 flex-grow">
                        {view === 'auth' && <AuthView setDbUser={setDbUser} setView={setView} appId={appId} db={db} />}
                        {view === 'admin' && <AdminView teams={teams} matchdays={matchdays} bets={bets} appId={appId} db={db} />}
                        {view === 'user' && <UserView teams={teams} matchdays={matchdays} bets={bets} user={dbUser} appId={appId} db={db} />}
                    </main>

                    <footer className="bg-gray-800 text-white p-4 text-center text-sm no-print">
                        Quiniela Amigos SICAR - Sistema Seguro
                    </footer>
                </div>
            );
        }

        function AuthView({ setDbUser, setView, appId, db }) {
            const [mode, setMode] = useState('login'); 
            const [formData, setFormData] = useState({ fullName: '', username: '', password: '', dob: '', newPassword: '' });
            const [error, setError] = useState('');

            const isValidUsername = (u) => /^[a-zA-Z0-9_]+$/.test(u);
            const isValidName = (n) => /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(n); // Solo letras y espacios
            
            const isAdult = (dateString) => {
                const today = new Date();
                const birthDate = new Date(dateString);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                return age >= 18;
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                if (!formData.fullName.trim()) return setError('Ingresa tu nombre completo.');
                if (!isValidName(formData.fullName)) return setError('El nombre solo debe contener letras (sin números ni símbolos).');
                if (!isValidUsername(formData.username)) return setError('Usuario inválido (solo letras, números y guión bajo).');
                if (formData.password.length < 5) return setError('La contraseña debe tener al menos 5 caracteres.');
                if (!isAdult(formData.dob)) return setError('Debes ser mayor de 18 años para registrarte.');

                try {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) return setError('El usuario ya existe.');

                    const newUser = {
                        fullName: formData.fullName.trim(), // Guardamos nombre real
                        username: formData.username,
                        password: formData.password, 
                        dob: formData.dob,
                        role: 'player', 
                        createdAt: serverTimestamp()
                    };
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', formData.username), newUser);
                    alert("Registro exitoso. Por favor inicia sesión.");
                    setMode('login');
                } catch (err) { setError("Error al registrar: " + err.message); }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    // --- SEGURIDAD: SE ELIMINÓ EL ACCESO HARDCODEADO ---
                    // Ahora la única forma de ser admin es teniendo role: 'admin' en la base de datos de Firebase.

                    const docSnap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username), where('password', '==', formData.password)));
                    
                    if (docSnap.empty) return setError('Credenciales incorrectas.');
                    
                    const userData = docSnap.docs[0].data();
                    setDbUser(userData);
                    setView(userData.role === 'admin' ? 'admin' : 'user');
                } catch (err) { setError("Error de conexión."); console.error(err); }
            };

            const handleRecover = async (e) => {
                e.preventDefault();
                setError('');
                if (formData.newPassword.length < 5) return setError('Nueva contraseña muy corta.');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', formData.username);
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username), where('dob', '==', formData.dob));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) return setError('Datos no coinciden. Verifica usuario y fecha de nacimiento.');

                    await updateDoc(docRef, { password: formData.newPassword });
                    alert("Contraseña restablecida.");
                    setMode('login');
                } catch (err) { setError("Error al restablecer."); }
            };

            return (
                <div className="flex justify-center items-center min-h-[70vh] animate-fade-in">
                    <div className="bg-white p-8 rounded-xl shadow-xl w-full max-w-md border">
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">
                                {mode === 'login' ? 'Iniciar Sesión' : mode === 'register' ? 'Registro Nuevo' : 'Restablecer Clave'}
                            </h2>
                            <p className="text-gray-500 text-sm mt-1">
                                {mode === 'login' ? 'Acceso a Quiniela Amigos SICAR' : 'Únete a la diversión'}
                            </p>
                        </div>

                        <form onSubmit={mode === 'login' ? handleLogin : mode === 'register' ? handleRegister : handleRecover} className="space-y-4">
                            
                            {/* CAMPO DE NOMBRE COMPLETO (SOLO EN REGISTRO) */}
                            {mode === 'register' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                    <input 
                                        type="text" 
                                        required 
                                        value={formData.fullName} 
                                        onChange={e => setFormData({...formData, fullName: e.target.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')})} 
                                        className="w-full p-3 border rounded-lg" 
                                        placeholder="Tu nombre real (Solo letras)" 
                                    />
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium text-gray-700">Usuario</label>
                                <input type="text" required value={formData.username} onChange={e => setFormData({...formData, username: e.target.value.replace(/[^a-zA-Z0-9_]/g, '')})} className="w-full p-3 border rounded-lg" placeholder="Solo letras y números (Login)" />
                            </div>

                            {mode !== 'recover' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Contraseña</label>
                                    <input type="password" required value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full p-3 border rounded-lg" placeholder="Mínimo 5 caracteres" />
                                </div>
                            )}

                            {(mode === 'register' || mode === 'recover') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Fecha de Nacimiento {mode === 'register' && '(+18)'}</label>
                                    <input type="date" required value={formData.dob} onChange={e => setFormData({...formData, dob: e.target.value})} className="w-full p-3 border rounded-lg" />
                                </div>
                            )}

                            {mode === 'recover' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                                    <input type="password" required value={formData.newPassword} onChange={e => setFormData({...formData, newPassword: e.target.value})} className="w-full p-3 border rounded-lg" />
                                </div>
                            )}

                            {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded flex items-center gap-2"><XCircle size={16}/> {error}</div>}

                            <button type="submit" className="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition">
                                {mode === 'login' ? 'Entrar' : mode === 'register' ? 'Registrarse' : 'Cambiar Contraseña'}
                            </button>
                        </form>

                        <div className="mt-6 text-center space-y-2 text-sm">
                            {mode === 'login' && (
                                <>
                                    <p><button onClick={() => setMode('register')} className="text-blue-600 hover:underline">¿No tienes cuenta? Regístrate</button></p>
                                    <p><button onClick={() => setMode('recover')} className="text-gray-500 hover:underline">Olvidé mi contraseña</button></p>
                                </>
                            )}
                            {(mode === 'register' || mode === 'recover') && (
                                <button onClick={() => setMode('login')} className="text-gray-600 hover:underline">Volver al inicio</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminView({ teams, matchdays, bets, appId, db }) {
            const [tab, setTab] = useState('matchdays');
            const tabs = [
                { id: 'matchdays', icon: PlusCircle, label: 'Crear Jornada' },
                { id: 'approvals', icon: CheckCircle, label: 'Pagos/Gestión' },
                { id: 'users', icon: Users, label: 'Usuarios' },
                { id: 'results', icon: Trophy, label: 'Resultados' },
                { id: 'teams', icon: Shield, label: 'Equipos' },
            ];

            return (
                <div className="bg-white rounded-xl shadow-lg min-h-[80vh] overflow-hidden">
                    <div className="flex border-b overflow-x-auto">
                        {tabs.map(t => (
                            <button key={t.id} onClick={() => setTab(t.id)} className={`flex-1 min-w-[100px] py-4 font-medium flex justify-center items-center gap-2 border-b-2 transition ${tab === t.id ? 'border-green-700 text-green-700 bg-green-50' : 'border-transparent text-gray-500'}`}>
                                <t.icon size={18} /> <span className="text-sm md:text-base">{t.label}</span>
                            </button>
                        ))}
                    </div>
                    <div className="p-4 md:p-6">
                        {tab === 'matchdays' && <AdminMatchdays teams={teams} matchdays={matchdays} appId={appId} db={db} />}
                        {tab === 'approvals' && <AdminApprovals matchdays={matchdays} bets={bets} appId={appId} db={db} />}
                        {tab === 'users' && <AdminUsers appId={appId} db={db} />}
                        {tab === 'results' && <AdminResults matchdays={matchdays} bets={bets} appId={appId} db={db} />}
                        {tab === 'teams' && <AdminTeams teams={teams} appId={appId} db={db} />}
                    </div>
                </div>
            );
        }

        function AdminMatchdays({ teams, matchdays, appId, db }) {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');
            const [deadline, setDeadline] = useState('');
            const [matches, setMatches] = useState([{ home: '', away: '' }]);

            const getAvailableTeams = (currentRowIdx, currentSide) => {
                const usedInOtherRows = matches.flatMap((m, idx) => idx !== currentRowIdx ? [m.home, m.away] : []).filter(Boolean);
                const currentOpponent = currentSide === 'home' ? matches[currentRowIdx].away : matches[currentRowIdx].home;
                const blocked = [...usedInOtherRows];
                if (currentOpponent) blocked.push(currentOpponent);
                return teams.filter(t => !blocked.includes(t.name));
            };

            const updateMatch = (idx, field, val) => {
                const newMatches = [...matches];
                newMatches[idx][field] = val;
                setMatches(newMatches);
            };

            const handleCreate = async () => {
                if (!name || !price || !deadline || matches.some(m => !m.home || !m.away)) return alert("Completa todos los campos, incluyendo la fecha límite.");
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'matchdays'), {
                    name, 
                    price: Number(price), 
                    deadline: deadline, // Guardamos la fecha límite (string ISO)
                    matches: matches.map((m, i) => ({ ...m, id: i, result: null })), 
                    status: 'active', 
                    createdAt: serverTimestamp()
                });
                
                setName(''); setPrice(''); setDeadline(''); setMatches([{ home: '', away: '' }]);
                alert("Jornada Publicada");
            };

            return (
                <div className="grid lg:grid-cols-2 gap-8">
                    <div>
                        <h3 className="text-xl font-bold mb-4">Nueva Jornada</h3>
                        <div className="space-y-4">
                            <input value={name} onChange={e => setName(e.target.value)} placeholder="Nombre (ej. Jornada 5)" className="w-full p-3 border rounded-lg" />
                            <div className="grid grid-cols-2 gap-4">
                                <input type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="Costo Entrada ($)" className="w-full p-3 border rounded-lg" />
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1 ml-1">Fecha Límite para Apostar</label>
                                    <input 
                                        type="datetime-local" 
                                        value={deadline} 
                                        onChange={e => setDeadline(e.target.value)} 
                                        className="w-full p-3 border rounded-lg text-sm" 
                                    />
                                </div>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded-lg border space-y-3">
                                <label className="font-bold text-sm text-gray-700">Encuentros</label>
                                {matches.map((m, i) => (
                                    <div key={i} className="flex gap-2 items-center">
                                        <select className="flex-1 p-2 border rounded text-sm" value={m.home} onChange={e => updateMatch(i, 'home', e.target.value)}>
                                            <option value="">Local</option>
                                            {getAvailableTeams(i, 'home').map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                            {m.home && !getAvailableTeams(i, 'home').find(t=>t.name===m.home) && <option value={m.home}>{m.home}</option>}
                                        </select>
                                        <span className="font-bold text-gray-400">VS</span>
                                        <select className="flex-1 p-2 border rounded text-sm" value={m.away} onChange={e => updateMatch(i, 'away', e.target.value)}>
                                            <option value="">Visitante</option>
                                            {getAvailableTeams(i, 'away').map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                            {m.away && !getAvailableTeams(i, 'away').find(t=>t.name===m.away) && <option value={m.away}>{m.away}</option>}
                                        </select>
                                        <button onClick={() => setMatches(matches.filter((_, idx) => idx !== i))} className="text-red-500 hover:bg-red-100 p-1 rounded"><X size={16}/></button>
                                    </div>
                                ))}
                                <button onClick={() => setMatches([...matches, { home: '', away: '' }])} className="text-green-600 text-sm font-bold flex items-center gap-1"><PlusCircle size={14}/> Agregar Encuentro</button>
                            </div>
                            
                            <button onClick={handleCreate} className="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800">Publicar Jornada</button>
                        </div>
                    </div>
                    
                    <div className="border-l pl-0 lg:pl-8">
                        <h3 className="text-xl font-bold mb-4">Jornadas Activas</h3>
                        <div className="space-y-3 max-h-[500px] overflow-y-auto">
                            {matchdays.map(m => (
                                <div key={m.id} className="p-4 border rounded bg-white shadow-sm">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h4 className="font-bold">{m.name}</h4>
                                            {m.deadline && (
                                                <p className="text-xs text-red-500 flex items-center gap-1 mt-1">
                                                    <Clock size={12}/> Cierra: {new Date(m.deadline).toLocaleString()}
                                                </p>
                                            )}
                                        </div>
                                        <button onClick={async () => { if(confirm("¿Eliminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matchdays', m.id)); }} className="text-red-400 text-xs hover:text-red-600">Eliminar</button>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-2">{m.matches.length} partidos - ${m.price}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminUsers({ appId, db }) {
            const [users, setUsers] = useState([]);

            useEffect(() => {
                const unsub = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'users')), (s) => {
                    setUsers(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, []);

            const toggleRole = async (u) => {
                const newRole = u.role === 'admin' ? 'player' : 'admin';
                if (confirm(`¿Cambiar rol de ${u.username} a ${newRole.toUpperCase()}?`)) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { role: newRole });
                }
            };
            
            const handleDeleteUser = async (u) => {
                if (confirm(`¡ATENCIÓN!\n\n¿Estás seguro de ELIMINAR al usuario ${u.username}?\n\nEsta acción es irreversible.`)) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id));
                }
            };

            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Administración de Usuarios</h3>
                    <div className="overflow-x-auto bg-white rounded shadow border">
                        <table className="w-full text-left">
                            <thead className="bg-gray-100 text-gray-600 text-sm">
                                <tr>
                                    <th className="p-3">Nombre</th>
                                    <th className="p-3">Usuario</th>
                                    <th className="p-3">Edad</th>
                                    <th className="p-3">Rol</th>
                                    <th className="p-3">Acciones</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {users.map(u => {
                                    const age = new Date().getFullYear() - new Date(u.dob).getFullYear();
                                    return (
                                        <tr key={u.id} className="hover:bg-gray-50">
                                            <td className="p-3 font-medium text-green-800 capitalize">{u.fullName || '-'}</td>
                                            <td className="p-3 font-medium text-gray-600">{u.username}</td>
                                            <td className="p-3 text-gray-500">{age} años</td>
                                            <td className="p-3">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                    {u.role === 'admin' ? 'ADMIN' : 'JUGADOR'}
                                                </span>
                                            </td>
                                            <td className="p-3 flex gap-2">
                                                <button onClick={() => toggleRole(u)} className="text-xs border px-2 py-1 rounded hover:bg-gray-100 flex items-center gap-1">
                                                    <RefreshCw size={12}/> Cambiar Rol
                                                </button>
                                                <button onClick={() => handleDeleteUser(u)} className="text-xs border border-red-200 text-red-600 px-2 py-1 rounded hover:bg-red-50 flex items-center gap-1" title="Eliminar Usuario">
                                                    <Trash2 size={12}/> Eliminar
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function AdminApprovals({ matchdays, bets, appId, db }) {
            const togglePay = async (bet) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bets', bet.id), { status: bet.status === 'pending' ? 'paid' : 'pending' });
            };
            
            const handleDeleteBet = async (bet) => {
                if(confirm("¿Estás seguro de ELIMINAR este registro de quiniela?\n\nEsta acción no se puede deshacer.")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bets', bet.id));
                }
            };

            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Aprobar Pagos y Gestión</h3>
                    <div className="overflow-x-auto bg-white rounded border">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-gray-100 text-gray-600">
                                <tr><th className="p-3">Usuario</th><th className="p-3">Jornada</th><th className="p-3">Ref. Pago</th><th className="p-3">Estado</th><th className="p-3">Acciones</th></tr>
                            </thead>
                            <tbody className="divide-y">
                                {bets.map(b => {
                                    const m = matchdays.find(md => md.id === b.matchdayId);
                                    return (
                                        <tr key={b.id} className="hover:bg-gray-50">
                                            <td className="p-3 font-medium">{b.userName}</td>
                                            <td className="p-3">{m ? m.name : '???'}</td>
                                            <td className="p-3 font-mono text-gray-600 bg-gray-50">{b.paymentRef || 'N/A'}</td>
                                            <td className="p-3"><span className={`px-2 py-1 rounded font-bold text-xs ${b.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>{b.status === 'paid' ? 'PAGADO' : 'PENDIENTE'}</span></td>
                                            <td className="p-3 flex items-center gap-2">
                                                <button onClick={() => togglePay(b)} className={`text-xs px-3 py-1 rounded border min-w-[80px] ${b.status === 'paid' ? 'border-red-200 text-red-500' : 'bg-green-600 text-white'}`}>{b.status === 'paid' ? 'Revocar' : 'Aprobar'}</button>
                                                <button onClick={() => handleDeleteBet(b)} className="text-red-500 hover:bg-red-50 p-1.5 rounded border border-red-200" title="Eliminar Quiniela">
                                                    <Trash2 size={14}/>
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function AdminTeams({ teams, appId, db }) {
            const [newTeam, setNewTeam] = useState('');
            const handleAdd = async (e) => {
                e.preventDefault();
                if (!newTeam.trim()) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), { name: newTeam.trim() });
                setNewTeam('');
            };
            const handleDelete = async (id) => { if(confirm("¿Borrar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', id)); };
            return (
                <div className="max-w-xl mx-auto">
                    <h3 className="text-xl font-bold mb-4">Catálogo de Equipos</h3>
                    <form onSubmit={handleAdd} className="flex gap-2 mb-4"><input value={newTeam} onChange={e => setNewTeam(e.target.value)} placeholder="Nuevo Equipo" className="flex-1 p-2 border rounded" /><button className="bg-green-600 text-white px-4 rounded">Agregar</button></form>
                    <ul className="border rounded divide-y max-h-96 overflow-y-auto">{teams.map(t => <li key={t.id} className="p-3 flex justify-between hover:bg-gray-50"><span>{t.name}</span><button onClick={() => handleDelete(t.id)} className="text-red-500 text-xs">Eliminar</button></li>)}</ul>
                </div>
            );
        }

        function AdminResults({ matchdays, bets, appId, db }) {
            const [selId, setSelId] = useState('');
            const [res, setRes] = useState({});
            const m = matchdays.find(x => x.id === selId);
            
            // Lógica de cálculo de resultados en tiempo real
            const leaderboard = useMemo(() => {
                if (!m) return [];
                // Filtramos apuestas de esta jornada
                const matchdayBets = bets.filter(b => b.matchdayId === m.id);
                
                return matchdayBets.map(bet => {
                    // Calcular puntos comparando predicciones de la apuesta (bet.predictions) 
                    // con los resultados actuales (res) O los resultados guardados en BD (m.matches)
                    let points = 0;
                    bet.predictions.forEach(pred => {
                        const match = m.matches.find(match => match.id === pred.matchId);
                        // Usamos el resultado que se está editando (res) si existe, sino el guardado (match.result)
                        const currentResult = res[pred.matchId] || match?.result;
                        if (currentResult && currentResult === pred.prediction) {
                            points++;
                        }
                    });
                    return { ...bet, points };
                }).sort((a, b) => b.points - a.points); // Ordenar mayor a menor
            }, [m, bets, res]);
            
            // Calculo de bolsa acumulada para esta jornada
            const pot = useMemo(() => {
                if(!m) return 0;
                const paidBets = bets.filter(b => b.matchdayId === m.id && b.status === 'paid');
                return paidBets.length * (m.price || 0);
            }, [m, bets]);

            const save = async () => {
                if(!m || !confirm("¿Finalizar jornada? Esto guardará los resultados y el ranking oficial.")) return;
                const updated = m.matches.map(match => ({ ...match, result: res[match.id] || null }));
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matchdays', m.id), { matches: updated, status: 'finalized' });
                alert("Resultados Guardados y Jornada Finalizada.");
            };
            
            // Precargar resultados si ya existen
            useEffect(() => {
                if(m && m.matches) {
                    const loadedRes = {};
                    m.matches.forEach(match => {
                        if(match.result) loadedRes[match.id] = match.result;
                    });
                    setRes(loadedRes);
                } else {
                    setRes({});
                }
            }, [m]);

            return (
                <div className="grid lg:grid-cols-2 gap-8">
                    {/* COLUMNA IZQUIERDA: CAPTURA */}
                    <div>
                        <h3 className="text-xl font-bold mb-4">Captura de Resultados</h3>
                        <select className="w-full p-2 border rounded mb-6" value={selId} onChange={e => setSelId(e.target.value)}>
                            <option value="">Selecciona Jornada</option>
                            {matchdays.filter(x => x.status !== 'deleted').map(x => <option key={x.id} value={x.id}>{x.name} ({x.status})</option>)}
                        </select>
                        {m && (
                            <div className="bg-gray-50 p-6 rounded border">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h4 className="font-bold text-center">{m.name}</h4>
                                    <div className="text-right">
                                        <p className="text-xs text-gray-500">Bolsa Acumulada</p>
                                        <p className="text-lg font-bold text-green-700">${pot}</p>
                                    </div>
                                </div>
                                <div className="space-y-2 mb-6">
                                    {m.matches.map(match => (
                                        <div key={match.id} className="flex justify-between items-center bg-white p-2 rounded border">
                                            <span className="w-1/3 text-right text-sm font-medium">{match.home}</span>
                                            <div className="flex gap-1">
                                                {['L','E','V'].map(opt => {
                                                    const val = opt === 'L' ? 'local' : opt === 'E' ? 'tie' : 'visit';
                                                    const active = res[match.id] === val;
                                                    return <button key={opt} onClick={() => setRes({...res, [match.id]: val})} className={`w-8 h-8 rounded text-xs font-bold transition ${active ? 'bg-green-600 text-white shadow' : 'bg-gray-100 hover:bg-gray-200'}`}>{opt}</button>
                                                })}
                                            </div>
                                            <span className="w-1/3 text-left text-sm font-medium">{match.away}</span>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={save} className="w-full bg-blue-600 text-white py-3 rounded font-bold shadow hover:bg-blue-700">Guardar y Finalizar</button>
                            </div>
                        )}
                    </div>
                    
                    {/* COLUMNA DERECHA: TABLA DE POSICIONES */}
                    <div className="border-l pl-0 lg:pl-8">
                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                            <Trophy className="text-yellow-500" /> Tabla de Posiciones
                        </h3>
                        {!m ? (
                            <p className="text-gray-400 text-center py-10">Selecciona una jornada para ver el ranking.</p>
                        ) : (
                            <div className="bg-white rounded border overflow-hidden">
                                <div className="bg-gray-100 p-3 text-xs font-bold text-gray-600 uppercase flex justify-between">
                                    <span className="w-10 text-center">#</span>
                                    <span className="flex-1">Jugador</span>
                                    <span className="w-20 text-center">Estado</span>
                                    <span className="w-16 text-center">Puntos</span>
                                </div>
                                <div className="divide-y max-h-[500px] overflow-y-auto">
                                    {leaderboard.length === 0 ? (
                                        <p className="p-4 text-center text-gray-500 text-sm">No hay quinielas registradas.</p>
                                    ) : (
                                        leaderboard.map((bet, idx) => (
                                            <div key={bet.id} className={`flex justify-between items-center p-3 text-sm ${idx === 0 ? 'bg-yellow-50' : ''}`}>
                                                <span className={`w-10 text-center font-bold ${idx===0 ? 'text-yellow-600 text-lg' : 'text-gray-500'}`}>
                                                    {idx+1}
                                                </span>
                                                <span className="flex-1 font-medium truncate">
                                                    {bet.userName} 
                                                    {idx===0 && <Trophy size={14} className="inline ml-1 text-yellow-500"/>}
                                                </span>
                                                <span className="w-20 text-center">
                                                    <span className={`text-[10px] px-2 py-0.5 rounded-full ${bet.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                        {bet.status === 'paid' ? 'PAGADO' : 'PEND.'}
                                                    </span>
                                                </span>
                                                <span className="w-16 text-center font-bold text-blue-700 text-base">{bet.points}</span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }


        function UserView({ teams, matchdays, bets, user, appId, db }) {
            const [tab, setTab] = useState('play');
            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow overflow-hidden">
                    <div className="flex border-b">
                        <button onClick={() => setTab('play')} className={`flex-1 py-4 font-bold ${tab === 'play' ? 'text-green-700 bg-green-50' : 'text-gray-500'}`}>Jugar</button>
                        <button onClick={() => setTab('history')} className={`flex-1 py-4 font-bold ${tab === 'history' ? 'text-green-700 bg-green-50' : 'text-gray-500'}`}>Mis Quinielas</button>
                    </div>
                    <div className="p-6">
                        {tab === 'play' && <UserPlay matchdays={matchdays} user={user} bets={bets} appId={appId} db={db} />}
                        {tab === 'history' && <UserHistory matchdays={matchdays} user={user} bets={bets} />}
                    </div>
                </div>
            );
        }

        function UserPlay({ matchdays, user, bets, appId, db }) {
            const [selM, setSelM] = useState(null);
            const [preds, setPreds] = useState({});
            const [paymentRef, setPaymentRef] = useState('');
            const [submitting, setSubmitting] = useState(false);
            
            const active = matchdays.filter(m => m.status === 'active');

            const submit = async () => {
                if(!selM.matches.every(m => preds[m.id])) return alert("Completa todos los partidos");
                if(!paymentRef.trim()) return alert("Debes ingresar una referencia de pago");
                if(bets.some(b => b.userName === user.username && b.matchdayId === selM.id)) return alert("Ya jugaste esta jornada");
                
                // VALIDACIÓN DE TIEMPO ONLINE
                setSubmitting(true);
                try {
                    const onlineTime = await getTrustedTime();
                    const deadlineDate = new Date(selM.deadline);
                    if (onlineTime > deadlineDate) {
                        alert(`¡Lo sentimos! El tiempo límite para esta jornada ya pasó.\n\nCierre: ${deadlineDate.toLocaleString()}\nHora actual detectada: ${onlineTime.toLocaleString()}`);
                        setSubmitting(false);
                        return;
                    }
                } catch (error) { console.error("Error validando tiempo:", error); }

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bets'), {
                        matchdayId: selM.id, 
                        userName: user.username, 
                        predictions: Object.entries(preds).map(([k,v]) => ({ matchId: parseInt(k), prediction: v })), 
                        paymentRef: paymentRef.trim(),
                        status: 'pending', 
                        createdAt: serverTimestamp()
                    });
                    alert("Quiniela enviada exitosamente!"); 
                    setSelM(null); setPreds({}); setPaymentRef('');
                } catch (error) {
                    alert("Error al enviar. Intenta de nuevo.");
                } finally {
                    setSubmitting(false);
                }
            };

            if (selM) return (
                <div>
                    <button onClick={() => setSelM(null)} className="text-sm font-bold text-gray-500 mb-4">&larr; Volver</button>
                    <div className="text-center mb-6">
                        <h3 className="text-2xl font-bold mb-1">{selM.name}</h3>
                        <p className="text-green-700 font-bold">Costo: ${selM.price}</p>
                        {selM.deadline && (
                            <div className="flex justify-center items-center gap-2 mt-2 text-red-600 bg-red-50 p-2 rounded-lg inline-block">
                                <Clock size={16} />
                                <span className="text-sm font-bold">Cierra el: {new Date(selM.deadline).toLocaleString()}</span>
                            </div>
                        )}
                    </div>
                    
                    <div className="space-y-4 max-w-2xl mx-auto mb-6">
                        {selM.matches.map(m => (
                            <div key={m.id} className="bg-gray-50 p-4 rounded flex justify-between items-center border">
                                <span className="flex-1 text-right font-bold text-sm md:text-base">{m.home}</span>
                                <div className="flex gap-2 mx-4">
                                    {['L','E','V'].map(opt => {
                                        const val = opt === 'L' ? 'local' : opt === 'E' ? 'tie' : 'visit';
                                        return <button key={opt} onClick={() => setPreds({...preds, [m.id]: val})} className={`w-10 h-10 rounded-full font-bold border transition ${preds[m.id] === val ? 'bg-green-600 text-white scale-110' : 'bg-white text-gray-400'}`}>{opt}</button>
                                    })}
                                </div>
                                <span className="flex-1 text-left font-bold text-sm md:text-base">{m.away}</span>
                            </div>
                        ))}
                    </div>

                    <div className="max-w-2xl mx-auto">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Referencia de Pago / Folio de Transferencia</label>
                        <input type="text" value={paymentRef} onChange={e => setPaymentRef(e.target.value)} placeholder="Ej. Transferencia #12345 o Depósito OXXO" className="w-full p-3 border rounded-lg bg-yellow-50 mb-4" />
                        <button onClick={submit} disabled={submitting} className={`w-full text-white py-3 rounded-lg font-bold shadow transition flex justify-center items-center gap-2 ${submitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                            {submitting ? 'Verificando hora y enviando...' : 'Enviar Quiniela'}
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="grid gap-4 md:grid-cols-2">
                    {active.map(m => {
                        const played = bets.some(b => b.userName === user.username && b.matchdayId === m.id);
                        const isExpired = m.deadline && new Date() > new Date(m.deadline);
                        // Calcular Bolsa
                        const pot = bets.filter(b => b.matchdayId === m.id && b.status === 'paid').length * m.price;
                        
                        return (
                            <div key={m.id} className={`border p-6 rounded-lg transition relative overflow-hidden ${isExpired ? 'bg-gray-50 opacity-75' : 'bg-white hover:shadow-md'}`}>
                                {isExpired && (
                                    <div className="absolute top-0 right-0 bg-red-500 text-white text-xs px-2 py-1 font-bold rounded-bl-lg">CERRADA</div>
                                )}
                                <h3 className="font-bold text-xl text-green-800 mb-1">{m.name}</h3>
                                <div className="flex items-center gap-2 mb-4">
                                    <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold flex items-center gap-1">
                                        <Banknote size={12}/> Bolsa: ${pot}
                                    </span>
                                </div>

                                <div className="flex flex-col gap-1 mb-4 text-sm text-gray-500">
                                    <span>{m.matches.length} partidos - Costo: ${m.price}</span>
                                    {m.deadline && (
                                        <span className={`flex items-center gap-1 ${isExpired ? 'text-red-600 font-bold' : 'text-orange-600'}`}>
                                            <Clock size={12}/> {isExpired ? 'Finalizó el: ' : 'Límite: '} {new Date(m.deadline).toLocaleString()}
                                        </span>
                                    )}
                                </div>
                                
                                <button onClick={() => !played && !isExpired && setSelM(m)} disabled={played || isExpired} className={`w-full py-2 rounded font-bold ${played || isExpired ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}>
                                    {played ? 'Ya participaste' : isExpired ? 'Tiempo Agotado' : 'Jugar'}
                                </button>
                            </div>
                        );
                    })}
                    {active.length === 0 && <p className="col-span-2 text-center text-gray-400 py-8">No hay jornadas activas.</p>}
                </div>
            );
        }

        function UserHistory({ matchdays, user, bets }) {
            const myBets = bets.filter(b => b.userName === user.username);
            const [printBet, setPrintBet] = useState(null);

            useEffect(() => {
                if(printBet) { setTimeout(() => { window.print(); setPrintBet(null); }, 500); }
            }, [printBet]);

            if (printBet) return (
                <div className="fixed inset-0 bg-white z-[100] p-10 font-mono print-only">
                    <div className="border-2 border-black p-6 max-w-lg mx-auto">
                        <h1 className="text-2xl font-bold text-center border-b-2 border-black pb-4 mb-4">COMPROBANTE QUINIELA</h1>
                        <div className="mb-4 text-sm">
                            <p><strong>JUGADOR:</strong> {printBet.userName}</p>
                            <p><strong>REF. PAGO:</strong> {printBet.paymentRef}</p>
                            <p><strong>FECHA:</strong> {new Date().toLocaleDateString()}</p>
                        </div>
                        <div className="my-6 border-t border-b py-2 space-y-2">
                            {printBet.predictions.map((p, i) => {
                                const m = matchdays.find(md => md.id === printBet.matchdayId)?.matches.find(ma => ma.id === p.matchId);
                                return <div key={i} className="flex justify-between text-sm"><span>{m?.home} vs {m?.away}</span><span className="font-bold">{p.prediction === 'local' ? 'L' : p.prediction === 'tie' ? 'E' : 'V'}</span></div>
                            })}
                        </div>
                        <p className="text-center text-sm font-bold">Estado: {printBet.status.toUpperCase()}</p>
                    </div>
                </div>
            );

            return (
                <div className="space-y-4">
                    {myBets.map(b => {
                        const m = matchdays.find(md => md.id === b.matchdayId);
                        const points = m?.status === 'finalized' ? b.predictions.filter(p => m.matches.find(ma => ma.id === p.matchId)?.result === p.prediction).length : null;
                        return (
                            <div key={b.id} className="border p-4 rounded flex justify-between items-center bg-gray-50">
                                <div>
                                    <h4 className="font-bold">{m?.name}</h4>
                                    <div className="flex gap-2 mt-1">
                                        <span className={`text-xs px-2 py-1 rounded font-bold ${b.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{b.status === 'paid' ? 'PAGADO' : 'PENDIENTE'}</span>
                                        {points !== null && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">Aciertos: {points}</span>}
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">Ref: {b.paymentRef}</p>
                                </div>
                                <button onClick={() => setPrintBet(b)} className="text-gray-600 hover:text-green-700 flex items-center gap-1 border px-3 py-1 rounded bg-white"><Printer size={16}/> Ticket</button>
                            </div>
                        );
                    })}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
