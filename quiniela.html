<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiniela Amigos SICAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
        }
        /* Ocultar barra de scroll en tabs para estética móvil */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, setDoc, getDocs, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { Trophy, Users, PlusCircle, CheckCircle, Clock, Search, FileText, LogOut, Shield, User, Printer, XCircle, Menu, X, Lock, RefreshCw, KeyRound, Calendar, Trash2, AlertTriangle, Banknote, ChevronDown, ChevronUp } from 'https://esm.sh/lucide-react@0.263.1';

        // --- CONFIGURACIÓN FIREBASE (PROYECTO EXISTENTE) ---
        const localConfig = {
          apiKey: "AIzaSyA6uydlodXo1vnyqoocwzHytwt5W0riIDQ",
          authDomain: "blackjack-d6b7b.firebaseapp.com",
          projectId: "blackjack-d6b7b",
          storageBucket: "blackjack-d6b7b.appspot.com",
          messagingSenderId: "705363226577",
          appId: "1:705363226577:web:214cf8baa2c9fb48e73af0"
        };

        let firebaseConfig;
        let appId = 'default-app-id';
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } else {
                firebaseConfig = localConfig;
            }
        } catch (e) { console.error(e); }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UTILERIAS DE TIEMPO ---
        const getTrustedTime = async () => {
            try {
                const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
                const data = await response.json();
                return new Date(data.utc_datetime); 
            } catch (error) {
                console.warn("Fallo al consultar hora online, usando fallback local:", error);
                return new Date(); 
            }
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [authUser, setAuthUser] = useState(null); 
            const [dbUser, setDbUser] = useState(null);     
            const [view, setView] = useState('auth');       
            const [teams, setTeams] = useState([]);
            const [matchdays, setMatchdays] = useState([]);
            const [bets, setBets] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setAuthUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!authUser) return;
                
                const unsubTeams = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'teams')), (s) => {
                    setTeams(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name)));
                });
                const unsubMatchdays = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'matchdays')), (s) => {
                    setMatchdays(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                });
                const unsubBets = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'bets')), (s) => {
                    setBets(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                return () => { unsubTeams(); unsubMatchdays(); unsubBets(); };
            }, [authUser]);

            const handleLogout = () => {
                setDbUser(null);
                setView('auth');
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-green-700 font-bold">Cargando...</div>;

            return (
                <div className="min-h-screen flex flex-col bg-gray-50">
                    <nav className="bg-green-700 text-white shadow-lg p-3 md:p-4 sticky top-0 z-50 no-print">
                        <div className="container mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2 overflow-hidden">
                                <Trophy className="text-yellow-300 shrink-0" />
                                <span className="font-bold text-lg md:text-xl truncate">Quiniela Amigos SICAR</span>
                            </div>
                            {dbUser && (
                                <div className="flex items-center gap-3 md:gap-4 shrink-0">
                                    <span className="hidden md:inline text-sm opacity-90 font-medium capitalize">
                                        {dbUser.fullName || dbUser.username}
                                    </span>
                                    <button onClick={handleLogout} className="hover:bg-green-600 p-2 rounded-full transition" title="Cerrar Sesión">
                                        <LogOut size={20} />
                                    </button>
                                </div>
                            )}
                        </div>
                    </nav>

                    <main className="container mx-auto p-3 md:p-6 mb-20 flex-grow w-full max-w-5xl">
                        {view === 'auth' && <AuthView setDbUser={setDbUser} setView={setView} appId={appId} db={db} />}
                        {view === 'admin' && <AdminView teams={teams} matchdays={matchdays} bets={bets} appId={appId} db={db} />}
                        {view === 'user' && <UserView teams={teams} matchdays={matchdays} bets={bets} user={dbUser} appId={appId} db={db} />}
                    </main>

                    <footer className="bg-gray-800 text-white p-4 text-center text-xs md:text-sm no-print">
                        Quiniela Amigos SICAR - Sistema Seguro
                    </footer>
                </div>
            );
        }

        function AuthView({ setDbUser, setView, appId, db }) {
            const [mode, setMode] = useState('login'); 
            const [formData, setFormData] = useState({ fullName: '', username: '', password: '', dob: '', newPassword: '' });
            const [error, setError] = useState('');

            const isValidUsername = (u) => /^[a-zA-Z0-9_]+$/.test(u);
            const isValidName = (n) => /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(n);
            
            const isAdult = (dateString) => {
                const today = new Date();
                const birthDate = new Date(dateString);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                return age >= 18;
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                if (!formData.fullName.trim()) return setError('Ingresa tu nombre completo.');
                if (!isValidName(formData.fullName)) return setError('El nombre solo debe contener letras.');
                if (!isValidUsername(formData.username)) return setError('Usuario inválido (solo letras, números y guión bajo).');
                if (formData.password.length < 5) return setError('La contraseña debe tener al menos 5 caracteres.');
                if (!isAdult(formData.dob)) return setError('Debes ser mayor de 18 años para registrarte.');

                try {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username));
                    const snapshot = await getDocs(q);
                    if (!snapshot.empty) return setError('El usuario ya existe.');

                    const newUser = {
                        fullName: formData.fullName.trim(),
                        username: formData.username,
                        password: formData.password, 
                        dob: formData.dob,
                        role: 'player', 
                        createdAt: serverTimestamp()
                    };
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', formData.username), newUser);
                    alert("Registro exitoso. Por favor inicia sesión.");
                    setMode('login');
                } catch (err) { setError("Error al registrar: " + err.message); }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    const docSnap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username), where('password', '==', formData.password)));
                    if (docSnap.empty) return setError('Credenciales incorrectas.');
                    
                    const userData = docSnap.docs[0].data();
                    setDbUser(userData);
                    setView(userData.role === 'admin' ? 'admin' : 'user');
                } catch (err) { setError("Error de conexión."); console.error(err); }
            };

            const handleRecover = async (e) => {
                e.preventDefault();
                setError('');
                if (formData.newPassword.length < 5) return setError('Nueva contraseña muy corta.');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', formData.username);
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', formData.username), where('dob', '==', formData.dob));
                    const snapshot = await getDocs(q);
                    
                    if (snapshot.empty) return setError('Datos no coinciden.');

                    await updateDoc(docRef, { password: formData.newPassword });
                    alert("Contraseña restablecida.");
                    setMode('login');
                } catch (err) { setError("Error al restablecer."); }
            };

            return (
                <div className="flex justify-center items-center min-h-[70vh] animate-fade-in p-4">
                    <div className="bg-white p-6 md:p-8 rounded-xl shadow-xl w-full max-w-md border">
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">
                                {mode === 'login' ? 'Iniciar Sesión' : mode === 'register' ? 'Registro Nuevo' : 'Restablecer Clave'}
                            </h2>
                            <p className="text-gray-500 text-sm mt-1">Acceso a Quiniela Amigos SICAR</p>
                        </div>

                        <form onSubmit={mode === 'login' ? handleLogin : mode === 'register' ? handleRegister : handleRecover} className="space-y-4">
                            {mode === 'register' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                    <input type="text" required value={formData.fullName} onChange={e => setFormData({...formData, fullName: e.target.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')})} className="w-full p-3 border rounded-lg" placeholder="Tu nombre real (Solo letras)" />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Usuario</label>
                                <input type="text" required value={formData.username} onChange={e => setFormData({...formData, username: e.target.value.replace(/[^a-zA-Z0-9_]/g, '')})} className="w-full p-3 border rounded-lg" placeholder="Solo letras y números" />
                            </div>
                            {mode !== 'recover' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Contraseña</label>
                                    <input type="password" required value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full p-3 border rounded-lg" placeholder="Mínimo 5 caracteres" />
                                </div>
                            )}
                            {(mode === 'register' || mode === 'recover') && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Fecha de Nacimiento {mode === 'register' && '(+18)'}</label>
                                    <input type="date" required value={formData.dob} onChange={e => setFormData({...formData, dob: e.target.value})} className="w-full p-3 border rounded-lg" />
                                </div>
                            )}
                            {mode === 'recover' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                                    <input type="password" required value={formData.newPassword} onChange={e => setFormData({...formData, newPassword: e.target.value})} className="w-full p-3 border rounded-lg" />
                                </div>
                            )}
                            {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded flex items-center gap-2"><XCircle size={16}/> {error}</div>}
                            <button type="submit" className="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition shadow-md active:scale-95">
                                {mode === 'login' ? 'Entrar' : mode === 'register' ? 'Registrarse' : 'Cambiar Contraseña'}
                            </button>
                        </form>
                        <div className="mt-6 text-center space-y-3 text-sm">
                            {mode === 'login' && (
                                <>
                                    <p><button onClick={() => setMode('register')} className="text-blue-600 hover:underline py-1">¿No tienes cuenta? Regístrate</button></p>
                                    <p><button onClick={() => setMode('recover')} className="text-gray-500 hover:underline py-1">Olvidé mi contraseña</button></p>
                                </>
                            )}
                            {(mode === 'register' || mode === 'recover') && (
                                <button onClick={() => setMode('login')} className="text-gray-600 hover:underline py-2">Volver al inicio</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminView({ teams, matchdays, bets, appId, db }) {
            const [tab, setTab] = useState('matchdays');
            const tabs = [
                { id: 'matchdays', icon: PlusCircle, label: 'Jornadas' },
                { id: 'approvals', icon: CheckCircle, label: 'Pagos' },
                { id: 'users', icon: Users, label: 'Usuarios' },
                { id: 'results', icon: Trophy, label: 'Resultados' },
                { id: 'teams', icon: Shield, label: 'Equipos' },
            ];

            return (
                <div className="bg-white rounded-xl shadow-lg min-h-[80vh] overflow-hidden flex flex-col">
                    {/* Tabs con scroll horizontal suave para móviles */}
                    <div className="flex border-b overflow-x-auto hide-scrollbar">
                        {tabs.map(t => (
                            <button key={t.id} onClick={() => setTab(t.id)} className={`flex-1 min-w-[90px] py-4 px-2 font-medium flex flex-col md:flex-row justify-center items-center gap-1 md:gap-2 border-b-2 transition whitespace-nowrap ${tab === t.id ? 'border-green-700 text-green-700 bg-green-50' : 'border-transparent text-gray-500'}`}>
                                <t.icon size={20} /> <span className="text-xs md:text-sm">{t.label}</span>
                            </button>
                        ))}
                    </div>
                    <div className="p-4 md:p-6 flex-grow">
                        {tab === 'matchdays' && <AdminMatchdays teams={teams} matchdays={matchdays} appId={appId} db={db} />}
                        {tab === 'approvals' && <AdminApprovals matchdays={matchdays} bets={bets} appId={appId} db={db} />}
                        {tab === 'users' && <AdminUsers appId={appId} db={db} />}
                        {tab === 'results' && <AdminResults matchdays={matchdays} bets={bets} appId={appId} db={db} />}
                        {tab === 'teams' && <AdminTeams teams={teams} appId={appId} db={db} />}
                    </div>
                </div>
            );
        }

        function AdminMatchdays({ teams, matchdays, appId, db }) {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');
            const [deadline, setDeadline] = useState('');
            const [matches, setMatches] = useState([{ home: '', away: '' }]);

            const getAvailableTeams = (currentRowIdx, currentSide) => {
                const usedInOtherRows = matches.flatMap((m, idx) => idx !== currentRowIdx ? [m.home, m.away] : []).filter(Boolean);
                const currentOpponent = currentSide === 'home' ? matches[currentRowIdx].away : matches[currentRowIdx].home;
                const blocked = [...usedInOtherRows];
                if (currentOpponent) blocked.push(currentOpponent);
                return teams.filter(t => !blocked.includes(t.name));
            };

            const updateMatch = (idx, field, val) => {
                const newMatches = [...matches];
                newMatches[idx][field] = val;
                setMatches(newMatches);
            };

            const handleCreate = async () => {
                if (!name || !price || !deadline || matches.some(m => !m.home || !m.away)) return alert("Completa todos los campos, incluyendo la fecha límite.");
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'matchdays'), {
                    name, price: Number(price), deadline: deadline, matches: matches.map((m, i) => ({ ...m, id: i, result: null })), status: 'active', createdAt: serverTimestamp()
                });
                setName(''); setPrice(''); setDeadline(''); setMatches([{ home: '', away: '' }]);
                alert("Jornada Publicada");
            };

            return (
                <div className="grid lg:grid-cols-2 gap-8">
                    <div>
                        <h3 className="text-xl font-bold mb-4">Nueva Jornada</h3>
                        <div className="space-y-4">
                            <input value={name} onChange={e => setName(e.target.value)} placeholder="Nombre (ej. Jornada 5)" className="w-full p-3 border rounded-lg" />
                            <div className="grid grid-cols-2 gap-4">
                                <input type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="Costo ($)" className="w-full p-3 border rounded-lg" />
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1 ml-1">Fecha Límite</label>
                                    <input type="datetime-local" value={deadline} onChange={e => setDeadline(e.target.value)} className="w-full p-3 border rounded-lg text-sm" />
                                </div>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded-lg border space-y-4">
                                <label className="font-bold text-sm text-gray-700 block mb-2">Encuentros</label>
                                {matches.map((m, i) => (
                                    // MOBILE TWEAK: flex-col en móvil para inputs grandes, row en desktop
                                    <div key={i} className="flex flex-col md:flex-row gap-2 items-center bg-white p-2 rounded shadow-sm md:shadow-none md:bg-transparent border md:border-0">
                                        <select className="w-full md:flex-1 p-2 border rounded text-sm bg-white" value={m.home} onChange={e => updateMatch(i, 'home', e.target.value)}>
                                            <option value="">Local</option>
                                            {getAvailableTeams(i, 'home').map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                            {m.home && !getAvailableTeams(i, 'home').find(t=>t.name===m.home) && <option value={m.home}>{m.home}</option>}
                                        </select>
                                        
                                        <span className="font-bold text-gray-400 text-xs md:text-base">VS</span>
                                        
                                        <select className="w-full md:flex-1 p-2 border rounded text-sm bg-white" value={m.away} onChange={e => updateMatch(i, 'away', e.target.value)}>
                                            <option value="">Visitante</option>
                                            {getAvailableTeams(i, 'away').map(t => <option key={t.id} value={t.name}>{t.name}</option>)}
                                            {m.away && !getAvailableTeams(i, 'away').find(t=>t.name===m.away) && <option value={m.away}>{m.away}</option>}
                                        </select>
                                        
                                        <button onClick={() => setMatches(matches.filter((_, idx) => idx !== i))} className="w-full md:w-auto text-red-500 hover:bg-red-50 p-2 rounded border md:border-0 flex justify-center"><X size={16}/></button>
                                    </div>
                                ))}
                                <button onClick={() => setMatches([...matches, { home: '', away: '' }])} className="text-green-600 text-sm font-bold flex items-center gap-1 mt-2 p-2 hover:bg-green-50 rounded w-full md:w-auto"><PlusCircle size={14}/> Agregar Encuentro</button>
                            </div>
                            
                            <button onClick={handleCreate} className="w-full bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 shadow-lg active:scale-95 transition">Publicar Jornada</button>
                        </div>
                    </div>
                    
                    <div className="border-l-0 border-t pt-6 lg:pt-0 lg:border-t-0 lg:border-l pl-0 lg:pl-8">
                        <h3 className="text-xl font-bold mb-4">Jornadas Activas</h3>
                        <div className="space-y-3 max-h-[500px] overflow-y-auto">
                            {matchdays.map(m => (
                                <div key={m.id} className="p-4 border rounded bg-white shadow-sm">
                                    <div className="flex justify-between items-start">
                                        <div className="overflow-hidden">
                                            <h4 className="font-bold truncate">{m.name}</h4>
                                            {m.deadline && <p className="text-xs text-red-500 flex items-center gap-1 mt-1"><Clock size={12}/> {new Date(m.deadline).toLocaleString()}</p>}
                                        </div>
                                        <button onClick={async () => { if(confirm("¿Eliminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matchdays', m.id)); }} className="text-red-400 text-xs hover:text-red-600 ml-2">Eliminar</button>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-2">{m.matches.length} partidos - ${m.price}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminUsers({ appId, db }) {
            const [users, setUsers] = useState([]);
            useEffect(() => { const unsub = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'users')), (s) => setUsers(s.docs.map(d => ({ id: d.id, ...d.data() })))); return () => unsub(); }, []);
            const toggleRole = async (u) => { if (confirm(`¿Cambiar rol?`)) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id), { role: u.role === 'admin' ? 'player' : 'admin' }); };
            const handleDeleteUser = async (u) => { if (confirm(`¿Eliminar a ${u.username}?`)) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.id)); };

            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Usuarios</h3>
                    <div className="overflow-x-auto bg-white rounded shadow border">
                        <table className="w-full text-left whitespace-nowrap">
                            <thead className="bg-gray-100 text-gray-600 text-sm"><tr><th className="p-3">Nombre</th><th className="p-3">Usuario</th><th className="p-3">Rol</th><th className="p-3">Acciones</th></tr></thead>
                            <tbody className="divide-y text-sm">
                                {users.map(u => (
                                    <tr key={u.id}>
                                        <td className="p-3 font-medium capitalize">{u.fullName || '-'}</td>
                                        <td className="p-3 text-gray-600">{u.username}</td>
                                        <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>{u.role === 'admin' ? 'ADMIN' : 'JUGADOR'}</span></td>
                                        <td className="p-3 flex gap-2">
                                            <button onClick={() => toggleRole(u)} className="p-1 border rounded"><RefreshCw size={14}/></button>
                                            <button onClick={() => handleDeleteUser(u)} className="p-1 border border-red-200 text-red-600 rounded"><Trash2 size={14}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function AdminApprovals({ matchdays, bets, appId, db }) {
            const togglePay = async (b) => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bets', b.id), { status: b.status === 'pending' ? 'paid' : 'pending' });
            const delBet = async (b) => { if(confirm("¿Eliminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bets', b.id)); };
            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Pagos</h3>
                    <div className="overflow-x-auto bg-white rounded border">
                        <table className="w-full text-left text-sm whitespace-nowrap">
                            <thead className="bg-gray-100 text-gray-600"><tr><th className="p-3">Usuario</th><th className="p-3">Jornada</th><th className="p-3">Ref</th><th className="p-3">Estado</th><th className="p-3">Acción</th></tr></thead>
                            <tbody className="divide-y">
                                {bets.map(b => {
                                    const m = matchdays.find(md => md.id === b.matchdayId);
                                    return (
                                        <tr key={b.id}>
                                            <td className="p-3 font-medium">{b.userName}</td>
                                            <td className="p-3">{m ? m.name : '???'}</td>
                                            <td className="p-3 font-mono text-xs">{b.paymentRef}</td>
                                            <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${b.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>{b.status === 'paid'?'OK':'PEND'}</span></td>
                                            <td className="p-3 flex gap-2"><button onClick={() => togglePay(b)} className="text-xs border px-2 py-1 rounded">Cambiar</button><button onClick={() => delBet(b)} className="text-red-500"><Trash2 size={14}/></button></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function AdminTeams({ teams, appId, db }) {
            const [newTeam, setNewTeam] = useState('');
            const handleAdd = async (e) => { e.preventDefault(); if(!newTeam.trim()) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), { name: newTeam.trim() }); setNewTeam(''); };
            const handleDelete = async (id) => { if(confirm("¿Borrar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teams', id)); };
            return (
                <div className="max-w-xl mx-auto">
                    <h3 className="text-xl font-bold mb-4">Equipos</h3>
                    <form onSubmit={handleAdd} className="flex gap-2 mb-4"><input value={newTeam} onChange={e => setNewTeam(e.target.value)} placeholder="Nombre" className="flex-1 p-2 border rounded" /><button className="bg-green-600 text-white px-4 rounded">Add</button></form>
                    <ul className="border rounded divide-y max-h-80 overflow-y-auto">{teams.map(t => <li key={t.id} className="p-3 flex justify-between"><span>{t.name}</span><button onClick={() => handleDelete(t.id)} className="text-red-500"><Trash2 size={14}/></button></li>)}</ul>
                </div>
            );
        }

        function AdminResults({ matchdays, bets, appId, db }) {
            const [selId, setSelId] = useState('');
            const [res, setRes] = useState({});
            const m = matchdays.find(x => x.id === selId);
            const leaderboard = useMemo(() => {
                if (!m) return [];
                const matchdayBets = bets.filter(b => b.matchdayId === m.id);
                return matchdayBets.map(bet => {
                    let points = 0;
                    bet.predictions.forEach(pred => {
                        const match = m.matches.find(match => match.id === pred.matchId);
                        const currentResult = res[pred.matchId] || match?.result;
                        if (currentResult && currentResult === pred.prediction) points++;
                    });
                    return { ...bet, points };
                }).sort((a, b) => b.points - a.points);
            }, [m, bets, res]);
            
            const save = async () => { if(!m || !confirm("¿Finalizar?")) return; const updated = m.matches.map(match => ({ ...match, result: res[match.id] || null })); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matchdays', m.id), { matches: updated, status: 'finalized' }); alert("Guardado"); };
            useEffect(() => { if(m && m.matches) { const loadedRes = {}; m.matches.forEach(match => { if(match.result) loadedRes[match.id] = match.result; }); setRes(loadedRes); } else { setRes({}); } }, [m]);

            return (
                <div className="grid lg:grid-cols-2 gap-8">
                    <div>
                        <h3 className="text-xl font-bold mb-4">Captura</h3>
                        <select className="w-full p-2 border rounded mb-6" value={selId} onChange={e => setSelId(e.target.value)}><option value="">Selecciona Jornada</option>{matchdays.filter(x => x.status !== 'deleted').map(x => <option key={x.id} value={x.id}>{x.name}</option>)}</select>
                        {m && (
                            <div className="bg-gray-50 p-4 rounded border">
                                <h4 className="font-bold text-center mb-4">{m.name}</h4>
                                <div className="space-y-3 mb-6">
                                    {m.matches.map(match => (
                                        <div key={match.id} className="flex flex-col md:flex-row justify-between items-center bg-white p-2 rounded border gap-2">
                                            <span className="w-full md:w-1/3 text-center md:text-right text-sm font-medium">{match.home}</span>
                                            <div className="flex gap-1 justify-center">
                                                {['L','E','V'].map(opt => {
                                                    const val = opt === 'L' ? 'local' : opt === 'E' ? 'tie' : 'visit';
                                                    return <button key={opt} onClick={() => setRes({...res, [match.id]: val})} className={`w-8 h-8 rounded text-xs font-bold transition ${res[match.id] === val ? 'bg-green-600 text-white' : 'bg-gray-100'}`}>{opt}</button>
                                                })}
                                            </div>
                                            <span className="w-full md:w-1/3 text-center md:text-left text-sm font-medium">{match.away}</span>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={save} className="w-full bg-blue-600 text-white py-3 rounded font-bold shadow">Guardar Resultados</button>
                            </div>
                        )}
                    </div>
                    <div className="border-t pt-6 lg:pt-0 lg:border-t-0 lg:border-l pl-0 lg:pl-8">
                        <h3 className="text-xl font-bold mb-4">Ranking</h3>
                        {leaderboard.length > 0 ? (
                            <div className="bg-white rounded border overflow-hidden">
                                {leaderboard.map((bet, idx) => (
                                    <div key={bet.id} className={`flex justify-between items-center p-3 text-sm border-b ${idx===0?'bg-yellow-50':''}`}>
                                        <span className={`w-8 font-bold text-center ${idx===0?'text-yellow-600':''}`}>{idx+1}</span>
                                        <span className="flex-1 px-2 truncate">{bet.userName}</span>
                                        <span className="font-bold text-blue-700">{bet.points} pts</span>
                                    </div>
                                ))}
                            </div>
                        ) : <p className="text-gray-400 text-center">Sin datos</p>}
                    </div>
                </div>
            );
        }

        function UserView({ teams, matchdays, bets, user, appId, db }) {
            const [tab, setTab] = useState('play');
            return (
                <div className="max-w-4xl mx-auto bg-white rounded-xl shadow overflow-hidden flex flex-col h-full md:h-auto">
                    <div className="flex border-b">
                        <button onClick={() => setTab('play')} className={`flex-1 py-4 font-bold ${tab === 'play' ? 'text-green-700 bg-green-50' : 'text-gray-500'}`}>Jugar</button>
                        <button onClick={() => setTab('history')} className={`flex-1 py-4 font-bold ${tab === 'history' ? 'text-green-700 bg-green-50' : 'text-gray-500'}`}>Mis Quinielas</button>
                    </div>
                    <div className="p-4 md:p-6 flex-grow">
                        {tab === 'play' && <UserPlay matchdays={matchdays} user={user} bets={bets} appId={appId} db={db} />}
                        {tab === 'history' && <UserHistory matchdays={matchdays} user={user} bets={bets} />}
                    </div>
                </div>
            );
        }

        function UserPlay({ matchdays, user, bets, appId, db }) {
            const [selM, setSelM] = useState(null);
            const [preds, setPreds] = useState({});
            const [paymentRef, setPaymentRef] = useState('');
            const [submitting, setSubmitting] = useState(false);
            const [viewParticipantsId, setViewParticipantsId] = useState(null);
            const active = matchdays.filter(m => m.status === 'active');

            const submit = async () => {
                if(!selM.matches.every(m => preds[m.id])) return alert("Completa todos los partidos");
                if(!paymentRef.trim()) return alert("Ingresa referencia de pago");
                setSubmitting(true);
                try {
                    const onlineTime = await getTrustedTime();
                    if (onlineTime > new Date(selM.deadline)) { alert("Tiempo agotado"); setSubmitting(false); return; }
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bets'), {
                        matchdayId: selM.id, userName: user.username, userFullName: user.fullName || user.username, predictions: Object.entries(preds).map(([k,v]) => ({ matchId: parseInt(k), prediction: v })), paymentRef: paymentRef.trim(), status: 'pending', createdAt: serverTimestamp()
                    });
                    alert("Enviado!"); setSelM(null); setPreds({}); setPaymentRef('');
                } catch (e) { alert("Error"); } finally { setSubmitting(false); }
            };

            if (selM) return (
                <div>
                    <button onClick={() => setSelM(null)} className="text-sm font-bold text-gray-500 mb-4 flex items-center gap-1"><ChevronDown className="rotate-90" size={16}/> Volver</button>
                    <div className="text-center mb-6">
                        <h3 className="text-2xl font-bold mb-1">{selM.name}</h3>
                        <p className="text-green-700 font-bold">Costo: ${selM.price}</p>
                    </div>
                    <div className="space-y-4 max-w-2xl mx-auto mb-6">
                        {selM.matches.map(m => (
                            <div key={m.id} className="bg-gray-50 p-3 rounded flex flex-col md:flex-row justify-between items-center border gap-3 md:gap-0">
                                <span className="w-full md:flex-1 text-center md:text-right font-bold text-sm md:text-base">{m.home}</span>
                                <div className="flex gap-2 mx-4 justify-center">
                                    {['L','E','V'].map(opt => {
                                        const val = opt === 'L' ? 'local' : opt === 'E' ? 'tie' : 'visit';
                                        return <button key={opt} onClick={() => setPreds({...preds, [m.id]: val})} className={`w-12 h-10 md:w-10 md:h-10 rounded-lg md:rounded-full font-bold border transition ${preds[m.id] === val ? 'bg-green-600 text-white scale-110' : 'bg-white text-gray-400'}`}>{opt}</button>
                                    })}
                                </div>
                                <span className="w-full md:flex-1 text-center md:text-left font-bold text-sm md:text-base">{m.away}</span>
                            </div>
                        ))}
                    </div>
                    <div className="max-w-2xl mx-auto">
                        <input type="text" value={paymentRef} onChange={e => setPaymentRef(e.target.value)} placeholder="Ref. Pago / Folio" className="w-full p-3 border rounded-lg bg-yellow-50 mb-4" />
                        <button onClick={submit} disabled={submitting} className={`w-full text-white py-3 rounded-lg font-bold shadow ${submitting?'bg-gray-400':'bg-green-600 hover:bg-green-700'}`}>{submitting?'Enviando...':'Enviar Quiniela'}</button>
                    </div>
                </div>
            );

            return (
                <div className="grid gap-4 md:grid-cols-2">
                    {active.map(m => {
                        const played = bets.some(b => b.userName === user.username && b.matchdayId === m.id);
                        const isExpired = m.deadline && new Date() > new Date(m.deadline);
                        const paidBets = bets.filter(b => b.matchdayId === m.id && b.status === 'paid');
                        return (
                            <div key={m.id} className={`border p-5 rounded-lg relative overflow-hidden flex flex-col ${isExpired ? 'bg-gray-50' : 'bg-white shadow-sm'}`}>
                                {isExpired && <div className="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl">CERRADA</div>}
                                <h3 className="font-bold text-xl text-green-800 mb-1">{m.name}</h3>
                                <div className="flex items-center gap-2 mb-3"><span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1"><Banknote size={12}/> Bolsa: ${paidBets.length * m.price}</span></div>
                                <div className="text-sm text-gray-500 mb-4 space-y-1">
                                    <p>{m.matches.length} partidos - ${m.price}</p>
                                    {m.deadline && <p className={`flex items-center gap-1 ${isExpired?'text-red-500':'text-orange-500'}`}><Clock size={12}/> {new Date(m.deadline).toLocaleString()}</p>}
                                </div>
                                <div className="mt-auto space-y-3">
                                    <button onClick={() => setViewParticipantsId(viewParticipantsId === m.id ? null : m.id)} className="w-full text-blue-600 text-xs font-bold flex items-center justify-center gap-1 py-2 border rounded border-blue-100"><Users size={14}/> {paidBets.length} Participantes {viewParticipantsId===m.id?<ChevronUp size={12}/>:<ChevronDown size={12}/>}</button>
                                    {viewParticipantsId === m.id && <ul className="bg-blue-50 p-2 rounded text-xs text-gray-700 max-h-32 overflow-y-auto">{paidBets.map(b=><li key={b.id} className="truncate">• {b.userFullName||b.userName}</li>)}</ul>}
                                    <button onClick={() => !played && !isExpired && setSelM(m)} disabled={played || isExpired} className={`w-full py-2 rounded font-bold ${played||isExpired?'bg-gray-200 text-gray-400':'bg-green-600 text-white'}`}>{played?'Jugado':isExpired?'Cerrada':'Jugar'}</button>
                                </div>
                            </div>
                        );
                    })}
                    {active.length === 0 && <p className="text-center text-gray-400 col-span-2 py-10">Sin jornadas</p>}
                </div>
            );
        }

        function UserHistory({ matchdays, user, bets }) {
            const myBets = bets.filter(b => b.userName === user.username);
            const [printBet, setPrintBet] = useState(null);
            useEffect(() => { if(printBet) { setTimeout(() => { window.print(); setPrintBet(null); }, 500); } }, [printBet]);
            if(printBet) return <div className="fixed inset-0 bg-white z-[999] p-4 font-mono print-only"><h1>TICKET</h1><p>Usuario: {printBet.userName}</p><p>Ref: {printBet.paymentRef}</p><div className="my-4">{printBet.predictions.map((p,i)=><div key={i}>{matchdays.find(m=>m.id===printBet.matchdayId)?.matches.find(ma=>ma.id===p.matchId)?.home} vs ... : {p.prediction}</div>)}</div></div>;
            return <div className="space-y-4">{myBets.map(b => { const m = matchdays.find(md => md.id === b.matchdayId); return <div key={b.id} className="border p-4 rounded flex justify-between bg-gray-50"><div><h4 className="font-bold">{m?.name}</h4><p className="text-xs text-gray-500">Ref: {b.paymentRef}</p></div><div className="text-right"><span className={`text-xs font-bold px-2 py-1 rounded ${b.status==='paid'?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}`}>{b.status==='paid'?'PAGADO':'PEND'}</span><button onClick={()=>setPrintBet(b)} className="block mt-2 text-gray-400"><Printer size={16}/></button></div></div>})}</div>;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
